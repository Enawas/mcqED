// Gestionnaire de thème global
class ThemeManager {
    constructor() {
        this.currentTheme = localStorage.getItem('mcqed_theme') || 'light';
        this.init();
    }

    init() {
        // Appliquer le thème au chargement
        this.applyTheme(this.currentTheme);
        
        // Ajouter le bouton de thème à toutes les pages
        this.addThemeToggleButton();
        
        // Écouter les changements de thème depuis d'autres onglets
        window.addEventListener('storage', (e) => {
            if (e.key === 'mcqed_theme') {
                this.applyTheme(e.newValue);
            }
        });
    }

    applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        this.currentTheme = theme;
        localStorage.setItem('mcqed_theme', theme);
        
        // Mettre à jour l'icône du bouton
        this.updateThemeIcon();
        
        // Déclencher un événement personnalisé
        window.dispatchEvent(new CustomEvent('themeChanged', { detail: { theme } }));
    }

    toggleTheme() {
        const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
        this.applyTheme(newTheme);
        
        // Notification
        this.showNotification(`Thème ${newTheme === 'dark' ? 'sombre' : 'clair'} activé`);
    }

    updateThemeIcon() {
        const themeIcon = document.getElementById('theme-icon');
        if (themeIcon) {
            const icon = this.currentTheme === 'dark' ? 'fa-sun' : 'fa-moon';
            themeIcon.className = `fas ${icon}`;
        }
    }

    addThemeToggleButton() {
        // Vérifier si le bouton existe déjà
        if (document.getElementById('theme-toggle-btn')) {
            return;
        }

        // Trouver la barre de navigation
        const navbarNav = document.querySelector('.navbar-nav.ml-auto');
        if (!navbarNav) {
            return;
        }

        // Créer le bouton de thème
        const themeButton = document.createElement('div');
        themeButton.className = 'nav-item';
        themeButton.innerHTML = `
            <button class="nav-link btn btn-link" id="theme-toggle-btn" onclick="themeManager.toggleTheme()" title="Basculer le thème">
                <i class="fas fa-moon" id="theme-icon"></i>
            </button>
        `;

        // Insérer le bouton au début de la barre de navigation
        navbarNav.insertBefore(themeButton, navbarNav.firstChild);
        
        // Mettre à jour l'icône
        this.updateThemeIcon();
    }

    showNotification(message) {
        // Utiliser la fonction de notification existante si disponible
        if (typeof showNotification === 'function') {
            showNotification(message, 'info');
        } else {
            // Fallback simple
            console.log(message);
        }
    }
}

// Initialiser le gestionnaire de thème
let themeManager;

// Fonction globale pour le basculement de thème
function toggleTheme() {
    if (themeManager) {
        themeManager.toggleTheme();
    }
}

// Initialiser quand le DOM est prêt
document.addEventListener('DOMContentLoaded', function() {
    themeManager = new ThemeManager();
});