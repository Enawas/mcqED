<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Structure QCM - MCQED</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin: 50px auto;
            max-width: 1000px;
        }
        .debug-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .btn-debug {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: bold;
            margin: 10px 5px;
        }
        .btn-debug:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .status-ok {
            border-color: #28a745;
            background: #f8fff9;
        }
        .status-error {
            border-color: #dc3545;
            background: #fff8f8;
        }
        .status-warning {
            border-color: #ffc107;
            background: #fffbf0;
        }
        .qcm-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .qcm-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        .qcm-card.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1><i class="fas fa-database"></i> Debug Structure QCM MCQED</h1>
            <p class="text-muted">Analysez et diagnostiquez la structure des données QCM</p>
        </div>

        <!-- Vue d'ensemble -->
        <div class="debug-section">
            <h4><i class="fas fa-chart-bar"></i> Vue d'ensemble des QCM</h4>
            <div id="overview-stats" class="stats-grid"></div>
        </div>

        <!-- Liste des QCM -->
        <div class="debug-section">
            <h4><i class="fas fa-list"></i> Liste des QCM</h4>
            <div id="qcm-list"></div>
        </div>

        <!-- Détails du QCM sélectionné -->
        <div class="debug-section" id="qcm-details" style="display: none;">
            <h4><i class="fas fa-info-circle"></i> Détails du QCM</h4>
            <div id="qcm-details-content"></div>
        </div>

        <!-- Actions de debug -->
        <div class="debug-section">
            <h4><i class="fas fa-tools"></i> Actions de Debug</h4>
            <div class="row">
                <div class="col-md-4">
                    <button type="button" class="btn btn-outline-primary btn-block mb-2" onclick="exportAllQCMs()">
                        <i class="fas fa-download"></i> Exporter tous les QCM
                    </button>
                </div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-outline-warning btn-block mb-2" onclick="validateAllQCMs()">
                        <i class="fas fa-check-circle"></i> Valider Structure
                    </button>
                </div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-outline-danger btn-block mb-2" onclick="clearAllQCMs()">
                        <i class="fas fa-trash"></i> Vider tous les QCM
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-info btn-block mb-2" onclick="showStorageInfo()">
                        <i class="fas fa-database"></i> Info Stockage
                    </button>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-secondary btn-block mb-2" onclick="createSampleQCM()">
                        <i class="fas fa-plus"></i> Créer QCM Test
                    </button>
                </div>
            </div>
        </div>

        <!-- Logs de debug -->
        <div class="debug-section">
            <h4><i class="fas fa-terminal"></i> Logs de Debug</h4>
            <div id="debug-logs" class="code-block">
                <div class="text-muted">Les logs de debug apparaîtront ici...</div>
            </div>
        </div>

        <!-- Retour à l'accueil -->
        <div class="text-center mt-4">
            <a href="index.html" class="btn btn-secondary">
                <i class="fas fa-home"></i> Retour à l'accueil
            </a>
        </div>
    </div>

    <script>
        let selectedQCM = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadQCMs();
            showStorageInfo();
        });

        function loadQCMs() {
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            displayOverview(qcms);
            displayQCMList(qcms);
        }

        function displayOverview(qcms) {
            const statsContainer = document.getElementById('overview-stats');
            
            const totalQCMs = qcms.length;
            const totalQuestions = qcms.reduce((total, qcm) => {
                if (qcm.pages) {
                    return total + qcm.pages.reduce((pageTotal, page) => pageTotal + (page.questions ? page.questions.length : 0), 0);
                } else {
                    return total + (qcm.questions ? qcm.questions.length : 0);
                }
            }, 0);
            const totalPages = qcms.reduce((total, qcm) => total + (qcm.pages ? qcm.pages.length : 1), 0);
            const validQCMs = qcms.filter(qcm => qcm.title && qcm.description).length;

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalQCMs}</div>
                    <div class="stat-label">QCM Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalQuestions}</div>
                    <div class="stat-label">Questions Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalPages}</div>
                    <div class="stat-label">Pages Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${validQCMs}</div>
                    <div class="stat-label">QCM Valides</div>
                </div>
            `;
        }

        function displayQCMList(qcms) {
            const listContainer = document.getElementById('qcm-list');
            
            if (qcms.length === 0) {
                listContainer.innerHTML = '<div class="alert alert-info">Aucun QCM trouvé dans le stockage</div>';
                return;
            }

            listContainer.innerHTML = qcms.map((qcm, index) => {
                const questionCount = qcm.pages ? 
                    qcm.pages.reduce((total, page) => total + (page.questions ? page.questions.length : 0), 0) : 
                    (qcm.questions ? qcm.questions.length : 0);
                const pageCount = qcm.pages ? qcm.pages.length : 1;
                
                return `
                    <div class="qcm-card" onclick="selectQCM(${index})">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${qcm.title || 'QCM sans titre'}</h6>
                                <small class="text-muted">${qcm.description || 'Aucune description'}</small>
                            </div>
                            <div class="text-right">
                                <span class="badge badge-primary">${questionCount} questions</span>
                                <span class="badge badge-info">${pageCount} pages</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectQCM(index) {
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            selectedQCM = qcms[index];
            
            // Mettre à jour la sélection visuelle
            document.querySelectorAll('.qcm-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            
            displayQCMDetails(selectedQCM);
        }

        function displayQCMDetails(qcm) {
            const detailsContainer = document.getElementById('qcm-details');
            const contentContainer = document.getElementById('qcm-details-content');
            
            detailsContainer.style.display = 'block';
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informations générales</h6>
                        <p><strong>ID:</strong> ${qcm.id}</p>
                        <p><strong>Titre:</strong> ${qcm.title || 'Non défini'}</p>
                        <p><strong>Description:</strong> ${qcm.description || 'Non définie'}</p>
                        <p><strong>Créé le:</strong> ${qcm.createdAt ? new Date(qcm.createdAt).toLocaleString() : 'Non défini'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Structure</h6>
                        <p><strong>Pages:</strong> ${qcm.pages ? qcm.pages.length : 'Non défini'}</p>
                        <p><strong>Questions totales:</strong> ${qcm.pages ? 
                            qcm.pages.reduce((total, page) => total + (page.questions ? page.questions.length : 0), 0) : 
                            (qcm.questions ? qcm.questions.length : 'Non défini')}</p>
                        <p><strong>Structure:</strong> ${qcm.pages ? 'Avec pages' : 'Sans pages'}</p>
                    </div>
                </div>
            `;
            
            if (qcm.pages) {
                html += '<h6 class="mt-3">Détail des pages</h6>';
                qcm.pages.forEach((page, pageIndex) => {
                    html += `
                        <div class="alert alert-light">
                            <strong>Page ${pageIndex + 1}:</strong> ${page.name || 'Sans nom'} 
                            (${page.questions ? page.questions.length : 0} questions)
                        </div>
                    `;
                });
            }
            
            html += `
                <h6 class="mt-3">Données JSON</h6>
                <div class="code-block">${JSON.stringify(qcm, null, 2)}</div>
            `;
            
            contentContainer.innerHTML = html;
        }

        function exportAllQCMs() {
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            const dataStr = JSON.stringify(qcms, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'all-qcms-export.json';
            link.click();
            URL.revokeObjectURL(url);
            
            addLog('Tous les QCM exportés');
        }

        function validateAllQCMs() {
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            let validCount = 0;
            let errors = [];
            
            qcms.forEach((qcm, index) => {
                if (!qcm.title) errors.push(`QCM ${index}: Titre manquant`);
                if (!qcm.description) errors.push(`QCM ${index}: Description manquante`);
                if (!qcm.id) errors.push(`QCM ${index}: ID manquant`);
                
                if (qcm.pages) {
                    qcm.pages.forEach((page, pageIndex) => {
                        if (!page.id) errors.push(`QCM ${index}, Page ${pageIndex}: ID manquant`);
                        if (!page.questions) errors.push(`QCM ${index}, Page ${pageIndex}: Questions manquantes`);
                    });
                }
                
                validCount++;
            });
            
            let result = `Validation terminée: ${validCount} QCM(s) vérifié(s)\n`;
            if (errors.length > 0) {
                result += `Erreurs trouvées:\n${errors.join('\n')}`;
            } else {
                result += 'Aucune erreur trouvée';
            }
            
            addLog(result);
        }

        function clearAllQCMs() {
            if (confirm('Êtes-vous sûr de vouloir supprimer tous les QCM ? Cette action est irréversible.')) {
                localStorage.removeItem('mcqed_qcms');
                loadQCMs();
                document.getElementById('qcm-details').style.display = 'none';
                addLog('Tous les QCM supprimés');
            }
        }

        function showStorageInfo() {
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            const storageSize = new Blob([localStorage.getItem('mcqed_qcms') || '']).size;
            
            let info = '=== INFO STOCKAGE ===\n';
            info += `QCM stockés: ${qcms.length}\n`;
            info += `Taille des données: ${storageSize} bytes\n`;
            info += `Limite localStorage: ~5-10 MB\n`;
            info += `Utilisation: ${((storageSize / (5 * 1024 * 1024)) * 100).toFixed(2)}%\n`;
            
            addLog(info);
        }

        function createSampleQCM() {
            const sampleQCM = {
                id: Date.now().toString(),
                title: "QCM Test Debug",
                description: "QCM créé pour tester la structure",
                createdAt: new Date().toISOString(),
                pages: [
                    {
                        id: Date.now().toString() + "_1",
                        name: "Page Test 1",
                        questions: [
                            {
                                id: Date.now().toString() + "_q1",
                                text: "Question test 1",
                                type: "single",
                                options: [
                                    { id: "a", text: "Option A" },
                                    { id: "b", text: "Option B" }
                                ],
                                correctAnswers: ["a"]
                            }
                        ]
                    }
                ]
            };
            
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            qcms.push(sampleQCM);
            localStorage.setItem('mcqed_qcms', JSON.stringify(qcms));
            
            loadQCMs();
            addLog('QCM test créé');
        }

        function addLog(message) {
            const logs = document.getElementById('debug-logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `<br>[${timestamp}] ${message}`;
            logs.scrollTop = logs.scrollHeight;
        }
    </script>
</body>
</html> 