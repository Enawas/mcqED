<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Éditeur de Questions - MCQED</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="dark-mode.css">
    <script src="theme-init.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: #f8f9fa;
            color: #374151;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f1f3f4;
        }
        
        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea !important;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sidebar-brand:hover {
            color: #667eea !important;
            text-decoration: none;
        }
        
        .sidebar-user {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f1f3f4;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .user-info i {
            font-size: 1.2rem;
            color: #667eea;
        }
        
        .sidebar-nav {
            padding: 1rem 0;
        }
        
        .nav-section {
            margin-bottom: 2rem;
        }
        
        .nav-section-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .nav-item {
            margin: 0;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: #6b7280;
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        .nav-link:hover {
            background: #f3f4f6;
            color: #374151;
            text-decoration: none;
            border-left-color: #667eea;
        }
        
        .nav-item.active .nav-link {
            background: #667eea;
            color: #ffffff;
            border-left-color: #ffffff;
        }
        
        /* Style spécial pour le bouton Favoris quand il est actif */
        .nav-item.active .nav-link[onclick*="toggleFavoritesView"] {
            background: #dc2626 !important;
            color: #ffffff !important;
            border-left-color: #ffffff !important;
        }
        
        .nav-item.active .nav-link[onclick*="toggleFavoritesView"] i {
            color: #ffffff !important;
        }
        
        .nav-link i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }
        
        .nav-link span {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .nav-link.text-danger {
            color: #dc2626 !important;
        }
        
        .nav-link.text-danger:hover {
            background: #fef2f2;
            color: #dc2626 !important;
        }
        
        /* Styles pour le sous-menu Mon compte */
        .nav-item.has-submenu {
            position: relative;
        }
        
        .nav-item.has-submenu .nav-link {
            cursor: pointer;
        }
        
        .nav-item.has-submenu .nav-link::after {
            content: '\f107';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-left: auto;
            transition: transform 0.2s ease;
        }
        
        .nav-item.has-submenu.open .nav-link::after {
            transform: rotate(180deg);
        }
        
        .submenu {
            list-style: none;
            padding: 0;
            margin: 0;
            background: #f8f9fa;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease;
        }
        
        .nav-item.has-submenu.open .submenu {
            max-height: 200px;
        }
        
        .submenu .nav-link {
            padding-left: 3rem;
            font-size: 0.85rem;
            border-left: none;
        }
        
        .submenu .nav-link:hover {
            background: #e9ecef;
            border-left: none;
        }
        
        /* Mode sombre pour le sous-menu */
        [data-theme="dark"] .submenu {
            background: #1a1a1a;
        }
        
        [data-theme="dark"] .submenu .nav-link:hover {
            background: #333;
        }
        
        /* Mode sombre pour la sidebar */
        [data-theme="dark"] .sidebar {
            background: #1a1a1a;
            color: #ffffff;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }
        
        [data-theme="dark"] .sidebar-header {
            border-bottom: 1px solid #333;
            background: #111;
        }
        
        [data-theme="dark"] .sidebar-user {
            border-bottom: 1px solid #333;
            background: #222;
        }
        
        [data-theme="dark"] .user-info {
            color: #ccc;
        }
        
        [data-theme="dark"] .nav-section-title {
            color: #888;
        }
        
        [data-theme="dark"] .nav-link {
            color: #ccc;
        }
        
        [data-theme="dark"] .nav-link:hover {
            background: #333;
            color: #ffffff;
        }
        
        [data-theme="dark"] .nav-link.text-danger {
            color: #ff6b6b !important;
        }
        
        [data-theme="dark"] .nav-link.text-danger:hover {
            background: #4a1a1a;
            color: #ff6b6b !important;
        }
        
        /* Mode daltonien */
        [data-colorblind="enabled"] {
            filter: grayscale(100%) contrast(120%);
        }
        
        [data-colorblind="enabled"] .btn-primary,
        [data-colorblind="enabled"] .btn-success,
        [data-colorblind="enabled"] .btn-danger,
        [data-colorblind="enabled"] .btn-warning,
        [data-colorblind="enabled"] .btn-info {
            filter: grayscale(0%) contrast(150%);
        }
        
        [data-colorblind="enabled"] .nav-item.active .nav-link {
            background: #000000 !important;
            color: #ffffff !important;
        }
        
        .editor-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin: 20px auto;
            max-width: 1200px;
            padding-top: 100px;
            margin-left: 300px;
        }
        .question-form {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        .option-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }
        .option-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        .option-item.correct {
            border-color: #28a745;
            background: #f8fff9;
        }
        .option-item.incorrect {
            border-color: #dc3545;
            background: #fff8f8;
        }
        .btn-add-option {
            background: #28a745;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 18px;
            margin: 10px 0;
        }
        .btn-remove-option {
            background: #dc3545;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: white;
            font-size: 14px;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .btn-toggle-correct {
            background: #ffc107;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 12px;
            margin-top: 10px;
        }
        .btn-toggle-correct.correct {
            background: #28a745;
            color: white;
        }
        .question-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .question-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .question-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        .question-item.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .btn-qcm {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: bold;
            margin: 10px 5px;
        }
        .btn-qcm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
            text-decoration: none;
        }
        .password-toggle {
            cursor: pointer;
            color: #6c757d;
        }
        .password-toggle:hover {
            color: #667eea;
        }
        .modal-header.bg-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
        }
        .dropdown-header {
            color: #6c757d;
            font-weight: 600;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .dropdown-header i {
            margin-right: 0.5rem;
            color: #667eea;
        }
        
        /* Styles pour la section de conversion XML */
        .xml-conversion-section {
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            text-align: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .xml-conversion-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .xml-conversion-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        
        .xml-conversion-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-xml-convert {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-xml-convert:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
            text-decoration: none;
        }
        
        .btn-xml-import {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-xml-import:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
            text-decoration: none;
        }
        
        /* Styles pour la section d'importation */
        .import-section {
            border: 2px dashed #28a745;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #f8fff9 0%, #f0fff4 100%);
            text-align: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .import-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #28a745;
            margin-bottom: 1rem;
        }
        
        .import-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        
        .import-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-import-xml {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-import-xml:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
            text-decoration: none;
        }
        
        .btn-import-json {
            background: linear-gradient(45deg, #6f42c1, #5a32a3);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-import-json:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
            text-decoration: none;
        }
        
        /* Styles pour les cartes QCM - dimensions uniformes */
        .col-md-4 .card {
            height: 280px;
            display: flex;
            flex-direction: column;
            border: 1px solid #dee2e6;
            background: white;
        }
        
        .col-md-4 .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        /* Styles pour la carte d'ajout de QCM - design distinctif */
        .add-qcm-card {
            border: 2px dashed #dee2e6 !important;
            background: #f8f9fa !important;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .add-qcm-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(102, 126, 234, 0.05) 50%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .add-qcm-card:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .add-qcm-card:hover::before {
            opacity: 1;
        }
        
        .add-qcm-card .fa-plus {
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .add-qcm-card:hover .fa-plus {
            color: #667eea;
        }
        
        .add-qcm-card .card-title {
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .add-qcm-card:hover .card-title {
            color: #667eea;
        }
        
        .add-qcm-card .card-text {
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .add-qcm-card:hover .card-text {
            color: #667eea;
        }
        
        .add-qcm-card .btn-outline-primary {
            border-color: #667eea;
            color: #667eea;
            background: white;
            transition: all 0.3s ease;
        }
        
        .add-qcm-card .btn-outline-primary:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        @media (max-width: 768px) {
            .xml-conversion-buttons {
                flex-direction: column;
                align-items: center;
            }
            .xml-conversion-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <a class="sidebar-brand" href="#">
                <i class="fas fa-graduation-cap"></i> mcqED
            </a>
        </div>
        
        <div class="sidebar-user">
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span id="username-display">Utilisateur</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="favorites.html" class="nav-link">
                        <i class="fas fa-heart"></i>
                        <span>Favoris</span>
                    </a>
                </li>
            </ul>
            
            <div class="nav-section">
                <div class="nav-section-title">Outils</div>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="import.html" class="nav-link">
                            <i class="fas fa-upload"></i>
                            <span>Importer</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="question-editor.html" class="nav-link">
                            <i class="fas fa-edit"></i>
                            <span>Éditeur</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Système</div>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="password-generator.html" class="nav-link">
                            <i class="fas fa-key"></i>
                            <span>Générateur</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="diagnostic-login.html" class="nav-link">
                            <i class="fas fa-stethoscope"></i>
                            <span>Diagnostic</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="debug-login.html" class="nav-link">
                            <i class="fas fa-bug"></i>
                            <span>Debug</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Apparence</div>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="toggleDarkMode()">
                            <i class="fas fa-moon"></i>
                            <span>Mode sombre</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="toggleColorblindMode()">
                            <i class="fas fa-eye"></i>
                            <span>Mode daltonien</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section" style="margin-top: auto;">
                <ul class="nav-list">
                    <li class="nav-item has-submenu">
                        <a href="#" class="nav-link" onclick="toggleSubmenu(this)">
                            <i class="fas fa-user"></i>
                            <span>Mon compte</span>
                        </a>
                        <ul class="submenu">
                            <li class="nav-item">
                                <a href="admin-profile.html" class="nav-link">
                                    <i class="fas fa-user-shield"></i>
                                    <span>Profil administrateur</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link text-danger" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Déconnexion</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <div class="editor-container">
        <div class="row">
            <div class="col-md-8">
                <h1><i class="fas fa-edit"></i> Éditeur de Questions MCQED</h1>
                <p class="text-muted">Ajoutez et modifiez les questions de votre QCM</p>
                
                <!-- Informations du QCM -->
                <div class="alert alert-info" id="qcm-info">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5><i class="fas fa-info-circle"></i> Informations du QCM</h5>
                            <p id="qcm-details">Chargement...</p>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="showEditQCMInfoModal()">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                    </div>
                </div>

                <!-- Configuration du seuil de réussite -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-percentage"></i> Seuil de réussite</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="passing-threshold"><strong>Pourcentage minimum pour valider l'examen :</strong></label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="passing-threshold" 
                                               min="0" max="100" value="60" 
                                               placeholder="Ex: 60">
                                        <div class="input-group-append">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    <small class="form-text text-muted">
                                        Définissez le pourcentage minimum requis pour considérer l'examen comme réussi.
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label><strong>Exemples :</strong></label>
                                    <div class="small text-muted">
                                        <div>• 60% = Réussite standard</div>
                                        <div>• 70% = Réussite élevée</div>
                                        <div>• 80% = Réussite excellente</div>
                                        <div>• 50% = Réussite minimale</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="savePassingThreshold()">
                            <i class="fas fa-save"></i> Sauvegarder le seuil
                        </button>
                    </div>
                </div>

                <!-- Niveau de difficulté -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Niveau de difficulté</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="difficulty-level"><strong>Niveau de difficulté du QCM :</strong></label>
                                    <select class="form-control" id="difficulty-level">
                                        <option value="beginner">Beginner - Débutant</option>
                                        <option value="intermediate">Intermediate - Intermédiaire</option>
                                        <option value="advanced">Advanced - Avancé</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        Indiquez le niveau de difficulté pour aider les utilisateurs à choisir le bon QCM.
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label><strong>Description des niveaux :</strong></label>
                                    <div class="small text-muted">
                                        <div><strong>Beginner :</strong> Concepts de base, questions simples</div>
                                        <div><strong>Intermediate :</strong> Connaissances moyennes, questions modérées</div>
                                        <div><strong>Advanced :</strong> Concepts avancés, questions complexes</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveDifficultyLevel()">
                            <i class="fas fa-save"></i> Sauvegarder le niveau
                        </button>
                    </div>
                </div>

                <!-- Statut de publication -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-globe"></i> Statut de publication</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label><strong>Statut actuel :</strong></label>
                                    <div class="mt-2">
                                        <span id="current-status-badge" class="badge badge-secondary">Chargement...</span>
                                    </div>
                                    <small class="form-text text-muted">
                                        <strong>Brouillon :</strong> Le QCM n'est visible que par vous<br>
                                        <strong>Publié :</strong> Le QCM est visible et accessible par tous
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label><strong>Actions :</strong></label>
                                    <div class="mt-2">
                                        <button class="btn btn-warning btn-sm" onclick="setDraftStatus()" id="draft-btn">
                                            <i class="fas fa-edit"></i> Mettre en brouillon
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="setPublishedStatus()" id="publish-btn">
                                            <i class="fas fa-globe"></i> Publier
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Cliquez sur le bouton correspondant pour changer le statut du QCM.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gestion des pages -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-layer-group"></i> Gestion des pages</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="page-selector"><strong>Sélectionner une page :</strong></label>
                                    <select class="form-control" id="page-selector" onchange="selectPage()">
                                        <option value="">Choisir une page...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="new-page-name"><strong>Nouvelle page :</strong></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="new-page-name" placeholder="Nom de la page...">
                                        <div class="input-group-append">
                                            <button class="btn btn-success" onclick="createNewPage()">
                                                <i class="fas fa-plus"></i> Créer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="current-page-info" class="alert alert-secondary" style="display: none;">
                            <strong>Page actuelle :</strong> <span id="current-page-name"></span>
                            <span class="float-right">
                                <button class="btn btn-sm btn-warning" onclick="editPageName()">
                                    <i class="fas fa-edit"></i> Renommer
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePage()">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Formulaire d'ajout/modification de question -->
                <div class="question-form" id="question-form" style="display: none;">
                    <h5><i class="fas fa-plus-circle"></i> Ajouter une nouvelle question</h5>
                    
                    <div class="form-group">
                        <label for="question-text"><strong>Question :</strong></label>
                        <textarea class="form-control" id="question-text" rows="3" 
                                  placeholder="Entrez votre question ici..."></textarea>
                    </div>

                    <div class="form-group">
                        <label><strong>Type de question :</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question-type" id="type-single" value="single" checked>
                            <label class="form-check-label" for="type-single">
                                Question à choix unique
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question-type" id="type-multiple" value="multiple">
                            <label class="form-check-label" for="type-multiple">
                                Question à choix multiples
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label><strong>Options de réponse :</strong></label>
                        <div id="options-container">
                            <div class="option-item">
                                <input type="text" class="form-control" placeholder="Option A" data-option="a">
                                <button class="btn-toggle-correct" onclick="toggleCorrect('a')">Marquer comme correcte</button>
                            </div>
                            <div class="option-item">
                                <input type="text" class="form-control" placeholder="Option B" data-option="b">
                                <button class="btn-toggle-correct" onclick="toggleCorrect('b')">Marquer comme correcte</button>
                            </div>
                        </div>
                        <button class="btn btn-add-option" onclick="addOption()">
                            <i class="fas fa-plus"></i>
                        </button>
                        <small class="form-text text-muted">Cliquez sur "Marquer comme correcte" pour chaque bonne réponse</small>
                    </div>

                    <div class="form-group">
                        <label for="explanation"><strong>Explication (optionnel) :</strong></label>
                        <textarea class="form-control" id="explanation" rows="2" 
                                  placeholder="Explication de la réponse..."></textarea>
                    </div>

                    <div class="text-center">
                        <button class="btn btn-qcm" onclick="saveQuestion()">
                            <i class="fas fa-save"></i> Sauvegarder la question
                        </button>
                        <button class="btn btn-secondary" onclick="clearForm()">
                            <i class="fas fa-times"></i> Effacer
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <h5><i class="fas fa-list"></i> Questions du QCM</h5>
                <div id="questions-list" class="question-list">
                    <!-- La liste des questions sera générée ici -->
                </div>
                
                <!-- Statistiques -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-chart-bar"></i> Statistiques</h6>
                    </div>
                    <div class="card-body">
                        <div id="stats-content">
                            <p class="text-muted">Sélectionnez une page pour voir les statistiques</p>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button type="button" class="btn btn-success btn-block" onclick="exportQCM()">
                        <i class="fas fa-download"></i> Exporter le QCM
                    </button>
                    <button type="button" class="btn btn-danger btn-block" onclick="showDeleteQCMModal()">
                        <i class="fas fa-trash"></i> Supprimer ce QCM
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour créer un nouveau QCM -->
    <div class="modal fade" id="createQCMModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle"></i> Créer un nouveau QCM
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="create-qcm-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="qcm-title"><strong>Nom du QCM :</strong></label>
                                    <input type="text" class="form-control" id="qcm-title" required 
                                           placeholder="Ex: VMware vSphere, Docker, Kubernetes...">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="qcm-icon"><strong>Icône :</strong></label>
                                    <select class="form-control" id="qcm-icon">
                                        <option value="fas fa-server">Serveur</option>
                                        <option value="fas fa-cloud">Cloud</option>
                                        <option value="fas fa-database">Base de données</option>
                                        <option value="fas fa-network-wired">Réseau</option>
                                        <option value="fas fa-shield-alt">Sécurité</option>
                                        <option value="fas fa-code">Programmation</option>
                                        <option value="fas fa-mobile-alt">Mobile</option>
                                        <option value="fas fa-desktop">Desktop</option>
                                        <option value="fas fa-laptop">Laptop</option>
                                        <option value="fas fa-cogs">Configuration</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="qcm-description"><strong>Description :</strong></label>
                            <textarea class="form-control" id="qcm-description" rows="3" required
                                      placeholder="Décrivez le contenu et les objectifs de ce QCM..."></textarea>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Note :</strong> Après la création, vous pourrez ajouter des questions via l'éditeur de questions.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="createNewQCM()">
                        <i class="fas fa-plus"></i> Créer le QCM
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour éditer les informations du QCM -->
    <div class="modal fade" id="editQCMInfoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit"></i> Modifier les informations du QCM
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="edit-qcm-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="edit-qcm-title"><strong>Nom du QCM :</strong></label>
                                    <input type="text" class="form-control" id="edit-qcm-title" required 
                                           placeholder="Ex: VMware vSphere, Docker, Kubernetes...">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="edit-qcm-icon"><strong>Icône :</strong></label>
                                    <select class="form-control" id="edit-qcm-icon">
                                        <option value="fas fa-server">Serveur</option>
                                        <option value="fas fa-cloud">Cloud</option>
                                        <option value="fas fa-database">Base de données</option>
                                        <option value="fas fa-network-wired">Réseau</option>
                                        <option value="fas fa-shield-alt">Sécurité</option>
                                        <option value="fas fa-code">Programmation</option>
                                        <option value="fas fa-mobile-alt">Mobile</option>
                                        <option value="fas fa-desktop">Desktop</option>
                                        <option value="fas fa-laptop">Laptop</option>
                                        <option value="fas fa-cogs">Configuration</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-qcm-description"><strong>Description :</strong></label>
                            <textarea class="form-control" id="edit-qcm-description" rows="3" required
                                      placeholder="Décrivez le contenu et les objectifs de ce QCM..."></textarea>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Note :</strong> Ces modifications seront appliquées immédiatement au QCM.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="saveQCMInfo()">
                        <i class="fas fa-save"></i> Sauvegarder
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de suppression de QCM -->
    <div class="modal fade" id="deleteQCMModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i> Supprimer le QCM
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Attention !</strong> Cette action est irréversible.
                    </div>
                    <p>Vous êtes sur le point de supprimer le QCM : <strong id="qcm-to-delete-title"></strong></p>
                    <p class="text-muted">Cette action supprimera définitivement le QCM et toutes ses questions.</p>
                    
                                               <div class="form-group">
                               <label for="admin-password"><strong>Mot de passe de suppression :</strong></label>
                               <div class="input-group">
                                   <input type="password" class="form-control" id="admin-password" 
                                          placeholder="Entrez le mot de passe de suppression" required>
                                   <div class="input-group-append">
                                       <span class="input-group-text password-toggle" onclick="toggleAdminPassword()">
                                           <i class="fas fa-eye" id="admin-password-icon"></i>
                                       </span>
                                   </div>
                               </div>
                               <small class="form-text text-muted">Entrez le mot de passe de suppression configuré dans votre profil admin.</small>
                           </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteQCM()">
                        <i class="fas fa-trash"></i> Supprimer définitivement
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="config.js"></script>
    <script>
        let currentQCM = null;
        let currentQuestionId = null;
        let correctAnswers = [];
        let currentPageId = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkSession()) {
                window.location.href = 'login.html';
                return;
            }
            
            updateUserDisplay();
            loadQCMFromURL();
            
            // Vérifier si un QCM vient d'être converti
            checkConvertedQCM();
            
            // Mettre à jour l'état initial du bouton mode sombre
            const darkModeLink = document.querySelector('.nav-link[onclick="toggleDarkMode()"]');
            if (darkModeLink) {
                const icon = darkModeLink.querySelector('i');
                const span = darkModeLink.querySelector('span');
                
                // Récupérer le thème depuis localStorage ou utiliser 'light' par défaut
                const savedTheme = localStorage.getItem('mcqed_theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                
                if (savedTheme === 'dark') {
                    icon.className = 'fas fa-sun';
                    span.textContent = 'Mode clair';
                } else {
                    icon.className = 'fas fa-moon';
                    span.textContent = 'Mode sombre';
                }
            }
            
            // Mettre à jour l'état initial du bouton mode daltonien
            const colorblindLink = document.querySelector('.nav-link[onclick="toggleColorblindMode()"]');
            if (colorblindLink) {
                const icon = colorblindLink.querySelector('i');
                const span = colorblindLink.querySelector('span');
                
                // Récupérer le mode daltonien depuis localStorage ou utiliser 'disabled' par défaut
                const savedColorblindMode = localStorage.getItem('mcqed_colorblind') || 'disabled';
                document.documentElement.setAttribute('data-colorblind', savedColorblindMode);
                
                if (savedColorblindMode === 'enabled') {
                    icon.className = 'fas fa-eye-slash';
                    span.textContent = 'Mode normal';
                } else {
                    icon.className = 'fas fa-eye';
                    span.textContent = 'Mode daltonien';
                }
            }
        });

        function checkSession() {
            const sessionData = sessionStorage.getItem('mcqed_session');
            if (!sessionData) {
                return false;
            }

            try {
                const session = JSON.parse(sessionData);
                const now = Date.now();
                
                if (session.expiresAt <= now) {
                    sessionStorage.removeItem('mcqed_session');
                    return false;
                }
                
                return true;
            } catch (e) {
                sessionStorage.removeItem('mcqed_session');
                return false;
            }
        }

        function updateUserDisplay() {
            const sessionData = JSON.parse(sessionStorage.getItem('mcqed_session'));
            document.getElementById('username-display').textContent = sessionData.userId;
        }

        function logout() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                sessionStorage.removeItem('mcqed_session');
                window.location.href = 'login.html';
            }
        }

        function loadQCMFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const qcmId = urlParams.get('qcm');
            
            if (!qcmId) {
                showQCMSelection();
                return;
            }

            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            currentQCM = qcms.find(qcm => qcm.id === qcmId);
            
            if (!currentQCM) {
                alert('QCM non trouvé');
                showQCMSelection();
                return;
            }

            displayQCMInfo();
            initializePages();
        }

        function checkConvertedQCM() {
            const convertedQcmId = sessionStorage.getItem('edit_converted_qcm');
            if (convertedQcmId && currentQCM && currentQCM.id === convertedQcmId) {
                // Nettoyer le flag
                sessionStorage.removeItem('edit_converted_qcm');
                
                // Afficher un message de confirmation
                showNotification('QCM converti avec succès ! Vous pouvez maintenant l\'éditer.', 'success');
                
                // Mettre à jour le statut par défaut à "draft" pour les QCMs convertis
                if (currentQCM.status === 'draft') {
                    updateStatusDisplay('draft');
                }
            }
        }

        function showQCMSelection() {
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            
            if (qcms.length === 0) {
                document.querySelector('.editor-container').innerHTML = `
                    <div class="text-center">
                        <h2><i class="fas fa-exclamation-triangle text-warning"></i> Aucun QCM disponible</h2>
                        <p class="text-muted">Vous devez d'abord créer un QCM depuis la page d'accueil.</p>
                        
                        <a href="index.html" class="btn btn-primary">
                            <i class="fas fa-home"></i> Retour à l'accueil
                        </a>
                    </div>
                `;
                return;
            }

            document.querySelector('.editor-container').innerHTML = `
                <div class="text-center">
                    <h2><i class="fas fa-edit"></i> Sélectionner un QCM à éditer</h2>
                    <p class="text-muted">Choisissez le QCM que vous souhaitez modifier :</p>
                    
                    <div class="row justify-content-center">
                        ${qcms.map(qcm => `
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="${qcm.iconClass || 'fas fa-question'} fa-3x text-primary mb-3"></i>
                                        <h5 class="card-title">${qcm.title}</h5>
                                        <p class="card-text text-muted">${qcm.description}</p>
                                        <a href="question-editor.html?qcm=${qcm.id}" class="btn btn-primary">
                                            <i class="fas fa-edit"></i> Éditer ce QCM
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        
                        <!-- Bouton pour ajouter un nouveau QCM -->
                        <div class="col-md-4 mb-3">
                            <div class="card add-qcm-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-plus fa-3x text-primary mb-3"></i>
                                    <h5 class="card-title">Ajouter un QCM</h5>
                                    <p class="card-text text-muted">Créez un nouveau thème de QCM personnalisé.</p>
                                    <button class="btn btn-outline-primary btn-block" onclick="showAddQCMModal()">
                                        <i class="fas fa-plus"></i> Créer un QCM
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                


                     <div class="mt-4">
                        <a href="index.html" class="btn btn-secondary">
                            <i class="fas fa-home"></i> Retour à l'accueil
                        </a>
                    </div>
                    </div>
            `;
        }

        function displayQCMInfo() {
            const totalQuestions = currentQCM.pages ? 
                currentQCM.pages.reduce((total, page) => total + page.questions.length, 0) : 
                (currentQCM.questions ? currentQCM.questions.length : 0);
            
            document.getElementById('qcm-details').innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="${currentQCM.iconClass || 'fas fa-question'} fa-2x text-primary mr-3"></i>
                    <div>
                        <strong>${currentQCM.title}</strong><br>
                        ${currentQCM.description}
                    </div>
                </div>
                <small class="text-muted">${totalQuestions} questions total</small>
            `;
            
            // Charger le seuil de réussite
            loadPassingThreshold();
            
            // Charger le niveau de difficulté
            loadDifficultyLevel();
            
            // Charger le statut de publication
            loadPublicationStatus();
        }

        function initializePages() {
            // Initialiser la structure des pages si elle n'existe pas
            if (!currentQCM.pages) {
                currentQCM.pages = [];
            }
            
            // Créer une page par défaut si aucune page n'existe
            if (currentQCM.pages.length === 0) {
                createDefaultPage();
            }
            
            updatePageSelector();
        }

        function createDefaultPage() {
            const defaultPage = {
                id: Date.now().toString(),
                name: "Page 1",
                questions: []
            };
            currentQCM.pages.push(defaultPage);
            currentPageId = defaultPage.id;
        }

        function updatePageSelector() {
            const selector = document.getElementById('page-selector');
            selector.innerHTML = '<option value="">Choisir une page...</option>';
            
            currentQCM.pages.forEach(page => {
                const option = document.createElement('option');
                option.value = page.id;
                option.textContent = page.name;
                selector.appendChild(option);
            });
        }

        function createNewPage() {
            if (!currentQCM) {
                alert('Aucun QCM sélectionné');
                return;
            }

            const pageName = document.getElementById('new-page-name').value.trim();
            if (!pageName) {
                alert('Veuillez entrer un nom pour la page');
                return;
            }

            // S'assurer que la structure des pages existe
            if (!currentQCM.pages) {
                currentQCM.pages = [];
            }

            const newPage = {
                id: Date.now().toString(),
                name: pageName,
                questions: []
            };

            currentQCM.pages.push(newPage);
            
            // Sauvegarder dans localStorage
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            const qcmIndex = qcms.findIndex(qcm => qcm.id === currentQCM.id);
            if (qcmIndex !== -1) {
                qcms[qcmIndex] = currentQCM;
                localStorage.setItem('mcqed_qcms', JSON.stringify(qcms));
            }

            updatePageSelector();
            document.getElementById('new-page-name').value = '';
            
            // Sélectionner automatiquement la nouvelle page
            selectPageById(newPage.id);
            
            showNotification('Page créée avec succès !', 'success');
        }

        function selectPage() {
            const pageId = document.getElementById('page-selector').value;
            if (pageId) {
                selectPageById(pageId);
            } else {
                hideQuestionForm();
            }
        }

        function selectPageById(pageId) {
            currentPageId = pageId;
            const page = currentQCM.pages.find(p => p.id === pageId);
            
            if (page) {
                document.getElementById('page-selector').value = pageId;
                document.getElementById('current-page-name').textContent = page.name;
                document.getElementById('current-page-info').style.display = 'block';
                document.getElementById('question-form').style.display = 'block';
                
                loadQuestionsForPage(pageId);
                updateStats();
            } else {
                console.error('Page non trouvée:', pageId);
                alert('Page non trouvée');
            }
        }

        function hideQuestionForm() {
            document.getElementById('current-page-info').style.display = 'none';
            document.getElementById('question-form').style.display = 'none';
            document.getElementById('questions-list').innerHTML = '<p class="text-muted">Sélectionnez une page pour voir les questions</p>';
            document.getElementById('stats-content').innerHTML = '<p class="text-muted">Sélectionnez une page pour voir les statistiques</p>';
        }

        function editPageName() {
            const page = currentQCM.pages.find(p => p.id === currentPageId);
            if (!page) return;

            const newName = prompt('Nouveau nom de la page:', page.name);
            if (newName && newName.trim()) {
                page.name = newName.trim();
                updatePageSelector();
                document.getElementById('current-page-name').textContent = page.name;
                showNotification('Nom de la page modifié !', 'success');
            }
        }

        function deletePage() {
            const page = currentQCM.pages.find(p => p.id === currentPageId);
            if (!page) return;

            if (page.questions.length > 0) {
                if (!confirm(`Cette page contient ${page.questions.length} question(s). Êtes-vous sûr de vouloir la supprimer ?`)) {
                    return;
                }
            }

            const pageIndex = currentQCM.pages.findIndex(p => p.id === currentPageId);
            if (pageIndex > -1) {
                currentQCM.pages.splice(pageIndex, 1);
                
                // Si c'était la dernière page, créer une page par défaut
                if (currentQCM.pages.length === 0) {
                    createDefaultPage();
                }
                
                updatePageSelector();
                hideQuestionForm();
                showNotification('Page supprimée !', 'success');
            }
        }

        function loadQuestionsForPage(pageId) {
            const page = currentQCM.pages.find(p => p.id === pageId);
            if (!page) return;

            const container = document.getElementById('questions-list');
            container.innerHTML = '';

            if (page.questions.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucune question dans cette page</p>';
                return;
            }

            page.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.onclick = () => editQuestion(question.id);
                questionDiv.innerHTML = `
                    <strong>Question ${index + 1}</strong><br>
                    <small>${question.text.substring(0, 50)}${question.text.length > 50 ? '...' : ''}</small><br>
                    <small class="text-muted">${question.type === 'single' ? 'Choix unique' : 'Choix multiples'}</small>
                `;
                container.appendChild(questionDiv);
            });
        }

        function updateStats() {
            const page = currentQCM.pages.find(p => p.id === currentPageId);
            if (!page) return;

            const statsContainer = document.getElementById('stats-content');
            const totalQuestions = page.questions.length;
            const singleChoice = page.questions.filter(q => q.type === 'single').length;
            const multipleChoice = page.questions.filter(q => q.type === 'multiple').length;

            statsContainer.innerHTML = `
                <div class="row text-center">
                    <div class="col-4">
                        <h6>${totalQuestions}</h6>
                        <small class="text-muted">Total</small>
                    </div>
                    <div class="col-4">
                        <h6>${singleChoice}</h6>
                        <small class="text-muted">Choix unique</small>
                    </div>
                    <div class="col-4">
                        <h6>${multipleChoice}</h6>
                        <small class="text-muted">Choix multiples</small>
                    </div>
                </div>
            `;
        }

        function loadQuestions() {
            const container = document.getElementById('questions-list');
            container.innerHTML = '';

            if (currentQCM.questions.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucune question pour le moment</p>';
                return;
            }

            currentQCM.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.onclick = () => editQuestion(question.id);
                questionDiv.innerHTML = `
                    <strong>Question ${index + 1}</strong><br>
                    <small>${question.text.substring(0, 50)}${question.text.length > 50 ? '...' : ''}</small><br>
                    <small class="text-muted">${question.type === 'single' ? 'Choix unique' : 'Choix multiples'}</small>
                `;
                container.appendChild(questionDiv);
            });
        }

        function addOption() {
            const container = document.getElementById('options-container');
            const optionCount = container.children.length;
            const optionLetter = String.fromCharCode(97 + optionCount); // a, b, c, d, etc.

            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.innerHTML = `
                <input type="text" class="form-control" placeholder="Option ${optionLetter.toUpperCase()}" data-option="${optionLetter}">
                <button class="btn-toggle-correct" onclick="toggleCorrect('${optionLetter}')">Marquer comme correcte</button>
                <button class="btn-remove-option" onclick="removeOption(this)">×</button>
            `;
            container.appendChild(optionDiv);
        }

        function removeOption(button) {
            button.parentElement.remove();
        }

        function toggleCorrect(optionLetter) {
            const button = event.target;
            const isCorrect = button.classList.contains('correct');
            
            if (isCorrect) {
                button.classList.remove('correct');
                button.textContent = 'Marquer comme correcte';
                correctAnswers = correctAnswers.filter(answer => answer !== optionLetter);
            } else {
                button.classList.add('correct');
                button.textContent = '✓ Correcte';
                correctAnswers.push(optionLetter);
            }
        }

        function saveQuestion() {
            const questionText = document.getElementById('question-text').value.trim();
            const questionType = document.querySelector('input[name="question-type"]:checked').value;
            const explanation = document.getElementById('explanation').value.trim();

            if (!questionText) {
                alert('Veuillez entrer une question');
                return;
            }

            if (correctAnswers.length === 0) {
                alert('Veuillez marquer au moins une réponse comme correcte');
                return;
            }

            // Récupérer les options
            const options = [];
            const optionElements = document.querySelectorAll('#options-container .option-item input');
            optionElements.forEach((input, index) => {
                const text = input.value.trim();
                if (text) {
                    options.push({
                        id: String.fromCharCode(97 + index),
                        text: text
                    });
                }
            });

            if (options.length < 2) {
                alert('Veuillez ajouter au moins 2 options');
                return;
            }

            const question = {
                id: currentQuestionId || Date.now().toString(),
                text: questionText,
                type: questionType,
                options: options,
                correctAnswers: correctAnswers,
                explanation: explanation
            };

            // Sauvegarder dans la page actuelle
            const currentPage = currentQCM.pages.find(p => p.id === currentPageId);
            if (!currentPage) {
                alert('Aucune page sélectionnée');
                return;
            }

            if (currentQuestionId) {
                // Modifier une question existante
                const index = currentPage.questions.findIndex(q => q.id === currentQuestionId);
                if (index !== -1) {
                    currentPage.questions[index] = question;
                }
            } else {
                // Ajouter une nouvelle question
                currentPage.questions.push(question);
            }

            // Sauvegarder dans localStorage
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            const qcmIndex = qcms.findIndex(qcm => qcm.id === currentQCM.id);
            if (qcmIndex !== -1) {
                qcms[qcmIndex] = currentQCM;
                localStorage.setItem('mcqed_qcms', JSON.stringify(qcms));
            }

            // Mettre à jour l'affichage
            displayQCMInfo();
            loadQuestions();
            clearForm();
            
            showNotification('Question sauvegardée avec succès !', 'success');
        }

        function editQuestion(questionId) {
            const currentPage = currentQCM.pages.find(p => p.id === currentPageId);
            if (!currentPage) return;
            
            const question = currentPage.questions.find(q => q.id === questionId);
            if (!question) return;

            currentQuestionId = questionId;
            correctAnswers = [...question.correctAnswers];

            // Remplir le formulaire
            document.getElementById('question-text').value = question.text;
            document.getElementById('explanation').value = question.explanation || '';
            
            // Sélectionner le type
            document.getElementById(`type-${question.type}`).checked = true;

            // Remplir les options
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-item';
                const isCorrect = correctAnswers.includes(option.id);
                optionDiv.innerHTML = `
                    <input type="text" class="form-control" value="${option.text}" data-option="${option.id}">
                    <button class="btn-toggle-correct ${isCorrect ? 'correct' : ''}" onclick="toggleCorrect('${option.id}')">
                        ${isCorrect ? '✓ Correcte' : 'Marquer comme correcte'}
                    </button>
                    ${index >= 2 ? '<button class="btn-remove-option" onclick="removeOption(this)">×</button>' : ''}
                `;
                container.appendChild(optionDiv);
            });

            // Scroll vers le formulaire
            document.querySelector('.question-form').scrollIntoView({ behavior: 'smooth' });
        }

        function clearForm() {
            document.getElementById('question-text').value = '';
            document.getElementById('explanation').value = '';
            document.getElementById('type-single').checked = true;
            document.getElementById('options-container').innerHTML = `
                <div class="option-item">
                    <input type="text" class="form-control" placeholder="Option A" data-option="a">
                    <button class="btn-toggle-correct" onclick="toggleCorrect('a')">Marquer comme correcte</button>
                </div>
                <div class="option-item">
                    <input type="text" class="form-control" placeholder="Option B" data-option="b">
                    <button class="btn-toggle-correct" onclick="toggleCorrect('b')">Marquer comme correcte</button>
                </div>
            `;
            correctAnswers = [];
            currentQuestionId = null;
        }

        function exportQCM() {
            // Préparer les données pour l'export avec la structure complète des pages
            const exportData = {
                ...currentQCM,
                // Exporter la structure complète des pages
                pages: currentQCM.pages || [],
                // Garder aussi les questions pour compatibilité avec l'ancien format
                questions: currentQCM.pages ? 
                    currentQCM.pages.flatMap(page => page.questions) : 
                    (currentQCM.questions || []),
                // Inclure le seuil de réussite
                passingThreshold: currentQCM.passingThreshold || 60,
                // Inclure le niveau de difficulté
                difficultyLevel: currentQCM.difficultyLevel || 'beginner',
                // Inclure le statut de publication
                status: currentQCM.status || 'draft'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentQCM.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification('QCM exporté avec succès !', 'success');
        }

        function importXMLFile(xmlString) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
            
            if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                alert('Erreur de parsing XML. Vérifiez le format de votre fichier.');
                return;
            }

            const quiz = xmlDoc.getElementsByTagName('Quiz')[0];
            if (!quiz) {
                alert('Aucun élément Quiz trouvé dans le fichier XML');
                return;
            }

            // Créer la structure JSON à partir du XML
            const qcmData = {
                id: Date.now().toString(),
                title: xmlDoc.querySelector('Quiz > Title')?.textContent || 'QCM Importé depuis XML',
                description: xmlDoc.querySelector('Quiz > Description')?.textContent || 'QCM converti depuis XML',
                passingThreshold: 60,
                status: 'draft',
                createdAt: new Date().toISOString(),
                pages: []
            };

            // Convertir les pages
            const pages = xmlDoc.getElementsByTagName('Page');
            for (let page of pages) {
                const pageNumber = page.getAttribute('number') || '1';
                const pageData = {
                    id: `page_${pageNumber}`,
                    name: `Page ${pageNumber}`,
                    questions: []
                };

                // Convertir les questions
                const questions = page.getElementsByTagName('Question');
                for (let question of questions) {
                    const questionId = question.getAttribute('id') || Date.now().toString();
                    const questionType = question.getAttribute('type') === 'multiple' ? 'multiple' : 'single';
                    
                    const questionText = question.getElementsByTagName('Text')[0]?.textContent || '';
                    const options = [];
                    const correctAnswers = [];

                    // Extraire les options
                    const optionElements = question.getElementsByTagName('Option');
                    for (let option of optionElements) {
                        const letter = option.getAttribute('letter');
                        const text = option.textContent;
                        options.push({
                            id: letter.toLowerCase(),
                            text: text
                        });
                    }

                    // Extraire les bonnes réponses
                    const answerElements = question.getElementsByTagName('Answer');
                    for (let answer of answerElements) {
                        correctAnswers.push(answer.textContent.toLowerCase());
                    }

                    const questionData = {
                        id: questionId,
                        text: questionText,
                        type: questionType,
                        options: options,
                        correctAnswers: correctAnswers,
                        explanation: '' // Pas d'explication dans le XML de base
                    };

                    pageData.questions.push(questionData);
                }

                qcmData.pages.push(pageData);
            }

            // Importer le QCM converti
            importQCMWithPages(qcmData);
        }

        function importXMLFileDirect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.xml')) {
                alert('Veuillez sélectionner un fichier XML');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const xmlString = e.target.result;
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
                    
                    if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                        alert('Erreur de parsing XML. Vérifiez le format de votre fichier.');
                        return;
                    }

                    const quiz = xmlDoc.getElementsByTagName('Quiz')[0];
                    if (!quiz) {
                        alert('Aucun élément Quiz trouvé dans le fichier XML');
                        return;
                    }

                    // Créer la structure JSON à partir du XML
                    const qcmData = {
                        id: Date.now().toString(),
                        title: xmlDoc.querySelector('Quiz > Title')?.textContent || 'QCM Importé depuis XML',
                        description: xmlDoc.querySelector('Quiz > Description')?.textContent || 'QCM converti depuis XML',
                        passingThreshold: 60,
                        status: 'draft',
                        createdAt: new Date().toISOString(),
                        pages: []
                    };

                    // Convertir les pages
                    const pages = xmlDoc.getElementsByTagName('Page');
                    for (let page of pages) {
                        const pageNumber = page.getAttribute('number') || '1';
                        const pageData = {
                            id: `page_${pageNumber}`,
                            name: `Page ${pageNumber}`,
                            questions: []
                        };

                        // Convertir les questions
                        const questions = page.getElementsByTagName('Question');
                        for (let question of questions) {
                            const questionId = question.getAttribute('id') || Date.now().toString();
                            const questionType = question.getAttribute('type') === 'multiple' ? 'multiple' : 'single';
                            
                            const questionText = question.getElementsByTagName('Text')[0]?.textContent || '';
                            const options = [];
                            const correctAnswers = [];

                            // Extraire les options
                            const optionElements = question.getElementsByTagName('Option');
                            for (let option of optionElements) {
                                const letter = option.getAttribute('letter');
                                const text = option.textContent;
                                options.push({
                                    id: letter.toLowerCase(),
                                    text: text
                                });
                            }

                            // Extraire les bonnes réponses
                            const answerElements = question.getElementsByTagName('Answer');
                            for (let answer of answerElements) {
                                correctAnswers.push(answer.textContent.toLowerCase());
                            }

                            const questionData = {
                                id: questionId,
                                text: questionText,
                                type: questionType,
                                options: options,
                                correctAnswers: correctAnswers,
                                explanation: '' // Pas d'explication dans le XML de base
                            };

                            pageData.questions.push(questionData);
                        }

                        qcmData.pages.push(pageData);
                    }

                    // Sauvegarder directement dans localStorage
                    const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
                    qcms.push(qcmData);
                    localStorage.setItem('mcqed_qcms', JSON.stringify(qcms));

                    // Afficher une notification de succès
                    showNotification('QCM XML importé avec succès !', 'success');

                    // Rediriger vers l'éditeur pour le QCM nouvellement créé
                    setTimeout(() => {
                        window.location.href = `question-editor.html?qcm=${qcmData.id}`;
                    }, 2000);

                } catch (error) {
                    alert('Erreur lors de l\'import du fichier XML : ' + error.message);
                }
            };
            reader.readAsText(file);

            // Réinitialiser l'input file
            event.target.value = '';
        }

        function importJSONFileDirect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.json')) {
                alert('Veuillez sélectionner un fichier JSON');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const qcmData = JSON.parse(e.target.result);
                    
                    // Vérifier la structure du JSON
                    if (!qcmData.title || !qcmData.pages || !Array.isArray(qcmData.pages)) {
                        alert('Le fichier JSON ne contient pas une structure de QCM valide');
                        return;
                    }

                    // Générer un nouvel ID pour éviter les conflits
                    qcmData.id = Date.now().toString();
                    qcmData.createdAt = new Date().toISOString();
                    
                    // S'assurer que le statut est défini
                    if (!qcmData.status) {
                        qcmData.status = 'draft';
                    }

                    // Sauvegarder directement dans localStorage
                    const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
                    qcms.push(qcmData);
                    localStorage.setItem('mcqed_qcms', JSON.stringify(qcms));

                    // Afficher une notification de succès
                    showNotification('QCM JSON importé avec succès !', 'success');

                    // Rediriger vers l'éditeur pour le QCM nouvellement créé
                    setTimeout(() => {
                        window.location.href = `question-editor.html?qcm=${qcmData.id}`;
                    }, 2000);

                } catch (error) {
                    alert('Erreur lors de l\'import du fichier JSON : ' + error.message);
                }
            };
            reader.readAsText(file);

            // Réinitialiser l'input file
            event.target.value = '';
        }

        function importQCM(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Vérifier si c'est un fichier XML ou JSON
                    if (file.name.toLowerCase().endsWith('.xml')) {
                        // Traiter comme un fichier XML
                        importXMLFile(e.target.result);
                    } else {
                        // Traiter comme un fichier JSON
                        const importedQCM = JSON.parse(e.target.result);
                        
                        // Vérifier si le QCM importé a une structure de pages
                        if (importedQCM.pages && importedQCM.pages.length > 0) {
                            // Importer avec la structure des pages
                            importQCMWithPages(importedQCM);
                        } else if (importedQCM.questions && importedQCM.questions.length > 0) {
                            // Importer l'ancien format (questions sans pages)
                            importQCMWithoutPages(importedQCM);
                        } else {
                            alert('Le fichier importé ne contient aucune question valide.');
                            return;
                        }
                    }
                } catch (error) {
                    alert('Erreur lors de l\'import : ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function importQCMWithPages(importedQCM) {
            // Importer chaque page avec son nom et ses questions
            let importedPagesCount = 0;
            
            importedQCM.pages.forEach((importedPage, index) => {
                // Créer une nouvelle page avec un ID unique
                const newPage = {
                    id: Date.now().toString() + '_' + index,
                    name: importedPage.name || `Page importée ${index + 1}`,
                    questions: importedPage.questions || []
                };
                
                currentQCM.pages.push(newPage);
                importedPagesCount++;
            });
            
            // Importer le seuil de réussite s'il existe
            if (importedQCM.passingThreshold !== undefined) {
                currentQCM.passingThreshold = importedQCM.passingThreshold;
            }
            
            // Importer le statut de publication s'il existe
            if (importedQCM.status !== undefined) {
                currentQCM.status = importedQCM.status;
            }
            
            // Importer le niveau de difficulté s'il existe
            if (importedQCM.difficultyLevel !== undefined) {
                currentQCM.difficultyLevel = importedQCM.difficultyLevel;
            }
            
            // Sauvegarder
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            const qcmIndex = qcms.findIndex(qcm => qcm.id === currentQCM.id);
            if (qcmIndex !== -1) {
                qcms[qcmIndex] = currentQCM;
                localStorage.setItem('mcqed_qcms', JSON.stringify(qcms));
            }

            displayQCMInfo();
            updatePageSelector();
            
            // Sélectionner la première page importée
            if (currentQCM.pages.length > 0) {
                const lastPage = currentQCM.pages[currentQCM.pages.length - importedPagesCount];
                selectPageById(lastPage.id);
            }
            
            showNotification(`${importedPagesCount} page(s) importée(s) avec succès !`, 'success');
        }

        function importQCMWithoutPages(importedQCM) {
            // Créer une nouvelle page pour les questions importées (ancien format)
            const importPage = {
                id: Date.now().toString(),
                name: `Import - ${new Date().toLocaleDateString()}`,
                questions: importedQCM.questions || []
            };
            
            currentQCM.pages.push(importPage);
            
            // Importer le seuil de réussite s'il existe
            if (importedQCM.passingThreshold !== undefined) {
                currentQCM.passingThreshold = importedQCM.passingThreshold;
            }
            
            // Importer le niveau de difficulté s'il existe
            if (importedQCM.difficultyLevel !== undefined) {
                currentQCM.difficultyLevel = importedQCM.difficultyLevel;
            }
            
            // Importer le statut de publication s'il existe
            if (importedQCM.status !== undefined) {
                currentQCM.status = importedQCM.status;
            }
            
            // Sauvegarder
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            const qcmIndex = qcms.findIndex(qcm => qcm.id === currentQCM.id);
            if (qcmIndex !== -1) {
                qcms[qcmIndex] = currentQCM;
                localStorage.setItem('mcqed_qcms', JSON.stringify(qcms));
            }

            displayQCMInfo();
            updatePageSelector();
            selectPageById(importPage.id);
            showNotification('QCM importé avec succès dans une nouvelle page !', 'success');
        }

        function showNotification(message, type) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Configuration de sécurité (même que dans login.html)
        // Configuration de sécurité centralisée
        const SECURITY_CONFIG = getSecurityConfig();

        function showDeleteQCMModal() {
            if (!currentQCM) {
                alert('Aucun QCM sélectionné');
                return;
            }

            document.getElementById('qcm-to-delete-title').textContent = currentQCM.title;
            document.getElementById('admin-password').value = '';
            $('#deleteQCMModal').modal('show');
        }

        function toggleAdminPassword() {
            const passwordInput = document.getElementById('admin-password');
            const passwordIcon = document.getElementById('admin-password-icon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordIcon.classList.remove('fa-eye');
                passwordIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                passwordIcon.classList.remove('fa-eye-slash');
                passwordIcon.classList.add('fa-eye');
            }
        }

        function loadPassingThreshold() {
            if (currentQCM && currentQCM.passingThreshold !== undefined) {
                document.getElementById('passing-threshold').value = currentQCM.passingThreshold;
            } else {
                // Valeur par défaut si non définie
                document.getElementById('passing-threshold').value = 60;
            }
        }

        function loadPublicationStatus() {
            if (!currentQCM) return;
            
            // Par défaut, si pas de statut défini, considérer comme brouillon
            const status = currentQCM.status || 'draft';
            updateStatusDisplay(status);
        }

        function updateStatusDisplay(status) {
            const badge = document.getElementById('current-status-badge');
            const draftBtn = document.getElementById('draft-btn');
            const publishBtn = document.getElementById('publish-btn');
            
            if (status === 'published') {
                badge.className = 'badge badge-success';
                badge.textContent = 'Publié';
                badge.innerHTML = '<i class="fas fa-globe"></i> Publié';
                
                draftBtn.disabled = false;
                publishBtn.disabled = true;
            } else {
                badge.className = 'badge badge-warning';
                badge.textContent = 'Brouillon';
                badge.innerHTML = '<i class="fas fa-edit"></i> Brouillon';
                
                draftBtn.disabled = true;
                publishBtn.disabled = false;
            }
        }

        function setDraftStatus() {
            if (!currentQCM) {
                alert('Aucun QCM sélectionné');
                return;
            }

            currentQCM.status = 'draft';
            saveQCMStatus();
            updateStatusDisplay('draft');
            showNotification('QCM mis en brouillon !', 'warning');
        }

        function setPublishedStatus() {
            if (!currentQCM) {
                alert('Aucun QCM sélectionné');
                return;
            }

            currentQCM.status = 'published';
            saveQCMStatus();
            updateStatusDisplay('published');
            showNotification('QCM publié avec succès !', 'success');
        }

        function saveQCMStatus() {
            // Sauvegarder dans localStorage
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            const qcmIndex = qcms.findIndex(qcm => qcm.id === currentQCM.id);
            if (qcmIndex !== -1) {
                qcms[qcmIndex] = currentQCM;
                localStorage.setItem('mcqed_qcms', JSON.stringify(qcms));
            }
        }

        function savePassingThreshold() {
            if (!currentQCM) {
                alert('Aucun QCM sélectionné');
                return;
            }

            const threshold = parseInt(document.getElementById('passing-threshold').value);
            
            if (isNaN(threshold) || threshold < 0 || threshold > 100) {
                alert('Veuillez entrer un pourcentage valide entre 0 et 100');
                return;
            }

            // Sauvegarder le seuil dans le QCM
            currentQCM.passingThreshold = threshold;
            
            // Sauvegarder dans localStorage
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            const qcmIndex = qcms.findIndex(qcm => qcm.id === currentQCM.id);
            if (qcmIndex !== -1) {
                qcms[qcmIndex] = currentQCM;
                localStorage.setItem('mcqed_qcms', JSON.stringify(qcms));
            }

            showNotification(`Seuil de réussite défini à ${threshold}% !`, 'success');
        }

        function loadDifficultyLevel() {
            if (currentQCM && currentQCM.difficultyLevel) {
                document.getElementById('difficulty-level').value = currentQCM.difficultyLevel;
            } else {
                // Valeur par défaut si non définie
                document.getElementById('difficulty-level').value = 'beginner';
            }
        }

        function saveDifficultyLevel() {
            if (!currentQCM) {
                alert('Aucun QCM sélectionné');
                return;
            }

            const difficultyLevel = document.getElementById('difficulty-level').value;
            
            if (!difficultyLevel) {
                alert('Veuillez sélectionner un niveau de difficulté');
                return;
            }

            // Sauvegarder le niveau dans le QCM
            currentQCM.difficultyLevel = difficultyLevel;
            
            // Sauvegarder dans localStorage
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            const qcmIndex = qcms.findIndex(qcm => qcm.id === currentQCM.id);
            if (qcmIndex !== -1) {
                qcms[qcmIndex] = currentQCM;
                localStorage.setItem('mcqed_qcms', JSON.stringify(qcms));
            }

            const difficultyLabels = {
                'beginner': 'Débutant',
                'intermediate': 'Intermédiaire',
                'advanced': 'Avancé'
            };

            showNotification(`Niveau de difficulté défini à ${difficultyLabels[difficultyLevel]} !`, 'success');
        }

        function showAddQCMModal() {
            $('#createQCMModal').modal('show');
        }

        function createNewQCM() {
            const title = document.getElementById('qcm-title').value.trim();
            const description = document.getElementById('qcm-description').value.trim();
            const iconClass = document.getElementById('qcm-icon').value;

            if (!title || !description) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }

            const newQCM = {
                id: Date.now().toString(),
                title: title,
                description: description,
                iconClass: iconClass || 'fas fa-server',
                status: 'draft',
                difficultyLevel: 'beginner',
                lastScore: 0,
                lastTime: 0,
                isFavorite: false,
                createdAt: new Date().toISOString(),
                questions: [],
                pages: []
            };

            // Sauvegarder dans localStorage
            const existingQCMs = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            existingQCMs.push(newQCM);
            localStorage.setItem('mcqed_qcms', JSON.stringify(existingQCMs));

            // Fermer le modal et réinitialiser le formulaire
            $('#createQCMModal').modal('hide');
            document.getElementById('create-qcm-form').reset();

            // Notification de succès
            showNotification('QCM créé avec succès !', 'success');

            // Rediriger vers l'éditeur du QCM nouvellement créé
            setTimeout(() => {
                window.location.href = `question-editor.html?qcm=${newQCM.id}`;
            }, 2000);
        }

        function showEditQCMInfoModal() {
            if (!currentQCM) {
                alert('Aucun QCM sélectionné');
                return;
            }

            // Remplir le formulaire avec les informations actuelles
            document.getElementById('edit-qcm-title').value = currentQCM.title || '';
            document.getElementById('edit-qcm-description').value = currentQCM.description || '';
            document.getElementById('edit-qcm-icon').value = currentQCM.iconClass || 'fas fa-server';

            // Afficher le modal
            $('#editQCMInfoModal').modal('show');
        }

        function saveQCMInfo() {
            if (!currentQCM) {
                alert('Aucun QCM sélectionné');
                return;
            }

            const title = document.getElementById('edit-qcm-title').value.trim();
            const description = document.getElementById('edit-qcm-description').value.trim();
            const iconClass = document.getElementById('edit-qcm-icon').value;

            if (!title || !description) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }

            // Mettre à jour les informations du QCM
            currentQCM.title = title;
            currentQCM.description = description;
            currentQCM.iconClass = iconClass;

            // Sauvegarder dans localStorage
            const existingQCMs = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            const qcmIndex = existingQCMs.findIndex(qcm => qcm.id === currentQCM.id);
            if (qcmIndex !== -1) {
                existingQCMs[qcmIndex] = currentQCM;
                localStorage.setItem('mcqed_qcms', JSON.stringify(existingQCMs));
            }

            // Fermer le modal
            $('#editQCMInfoModal').modal('hide');

            // Mettre à jour l'affichage
            displayQCMInfo();

            // Notification de succès
            showNotification('Informations du QCM mises à jour avec succès !', 'success');
        }

        function confirmDeleteQCM() {
            const adminPassword = document.getElementById('admin-password').value;
            
            if (!adminPassword) {
                alert('Veuillez entrer le mot de passe de suppression');
                return;
            }

            // Vérifier le mot de passe de suppression
            if (adminPassword !== SECURITY_CONFIG.deletionPassword) {
                alert('Mot de passe de suppression incorrect');
                document.getElementById('admin-password').value = '';
                document.getElementById('admin-password').focus();
                return;
            }

            // Supprimer le QCM
            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            const qcmIndex = qcms.findIndex(qcm => qcm.id === currentQCM.id);
            
            if (qcmIndex !== -1) {
                qcms.splice(qcmIndex, 1);
                localStorage.setItem('mcqed_qcms', JSON.stringify(qcms));
                
                // Fermer le modal
                $('#deleteQCMModal').modal('hide');
                
                // Afficher une notification
                showNotification('QCM supprimé avec succès !', 'success');
                
                // Rediriger vers la page d'accueil après un délai
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            } else {
                alert('Erreur lors de la suppression du QCM');
            }
        }
        
        // Fonction pour basculer le mode sombre
        function toggleDarkMode() {
            const darkModeLink = document.querySelector('.nav-link[onclick="toggleDarkMode()"]');
            const icon = darkModeLink.querySelector('i');
            const span = darkModeLink.querySelector('span');
            
            // Basculer le mode sombre en utilisant la fonction de dark-mode.js
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            // Appliquer le nouveau thème
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('mcqed_theme', newTheme);
            
            // Mettre à jour l'icône et le texte
            if (newTheme === 'dark') {
                icon.className = 'fas fa-sun';
                span.textContent = 'Mode clair';
            } else {
                icon.className = 'fas fa-moon';
                span.textContent = 'Mode sombre';
            }
        }
        
        // Fonction pour basculer le mode daltonien
        function toggleColorblindMode() {
            const colorblindLink = document.querySelector('.nav-link[onclick="toggleColorblindMode()"]');
            const icon = colorblindLink.querySelector('i');
            const span = colorblindLink.querySelector('span');
            
            // Basculer le mode daltonien
            const currentColorblindMode = document.documentElement.getAttribute('data-colorblind');
            const newColorblindMode = currentColorblindMode === 'enabled' ? 'disabled' : 'enabled';
            
            // Appliquer le mode daltonien
            document.documentElement.setAttribute('data-colorblind', newColorblindMode);
            localStorage.setItem('mcqed_colorblind', newColorblindMode);
            
            // Mettre à jour l'icône et le texte
            if (newColorblindMode === 'enabled') {
                icon.className = 'fas fa-eye-slash';
                span.textContent = 'Mode normal';
            } else {
                icon.className = 'fas fa-eye';
                span.textContent = 'Mode daltonien';
            }
        }
        
        // Fonction pour basculer le sous-menu Mon compte
        function toggleSubmenu(element) {
            const navItem = element.closest('.nav-item');
            const isOpen = navItem.classList.contains('open');
            
            // Fermer tous les autres sous-menus
            document.querySelectorAll('.nav-item.has-submenu').forEach(item => {
                item.classList.remove('open');
            });
            
            // Basculer l'état du sous-menu actuel
            if (!isOpen) {
                navItem.classList.add('open');
            }
        }
    </script>
    <script src="dark-mode.js"></script>
</body>
</html> 