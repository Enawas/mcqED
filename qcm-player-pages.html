<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur de QCM - MCQED</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="dark-mode.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .quiz-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin: 20px auto;
            max-width: 900px;
            margin-top: 40px;
        }
        .page-header {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }
        .question-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        .option-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .option-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .option-item.selected {
            border-color: #28a745;
            background: #f8fff9;
        }
        /* Styles pour les réponses correctes et incorrectes */
        .option-item.correct {
            border-color: #28a745 !important;
            background: #d4edda !important;
            color: #155724 !important;
        }
        .option-item.incorrect {
            border-color: #dc3545 !important;
            background: #f8d7da !important;
            color: #721c24 !important;
        }
        /* S'assurer que correct et incorrect ont la priorité sur selected */
        .option-item.correct.selected {
            border-color: #28a745 !important;
            background: #d4edda !important;
            color: #155724 !important;
        }
        .option-item.incorrect.selected {
            border-color: #dc3545 !important;
            background: #f8d7da !important;
            color: #721c24 !important;
        }
        /* Styles renforcés pour s'assurer que les couleurs sont appliquées */
        .option-item.correct,
        .option-item.correct:hover,
        .option-item.correct.selected,
        .option-item.correct.selected:hover {
            border-color: #28a745 !important;
            background: #d4edda !important;
            color: #155724 !important;
        }
        .option-item.incorrect,
        .option-item.incorrect:hover,
        .option-item.incorrect.selected,
        .option-item.incorrect.selected:hover {
            border-color: #dc3545 !important;
            background: #f8d7da !important;
            color: #721c24 !important;
        }
        /* Styles très spécifiques pour forcer l'application des couleurs */
        div.option-item.correct {
            border-color: #28a745 !important;
            background: #d4edda !important;
            color: #155724 !important;
        }
        div.option-item.incorrect {
            border-color: #dc3545 !important;
            background: #f8d7da !important;
            color: #721c24 !important;
        }
        .progress-bar {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        .btn-qcm {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: bold;
            margin: 10px 5px;
        }
        .btn-qcm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
            text-decoration: none;
        }
        .explanation-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
        }
        
        /* Styles pour le sélecteur de pages */
        .page-btn {
            min-width: 40px;
            border-radius: 20px !important;
            margin: 0 2px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .page-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2) !important;
            border-color: #667eea !important;
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }
        .page-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        .page-btn.completed {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            color: white !important;
        }
        .page-btn.completed:hover {
            background-color: #218838 !important;
        }
                 .page-indicator {
             background: #667eea;
             color: white;
             padding: 8px 16px;
             border-radius: 20px;
             font-weight: bold;
             margin-bottom: 20px;
         }
         
         .alert-sm {
             padding: 0.5rem 0.75rem;
             font-size: 0.875rem;
         }
         
         .incorrect-questions-list,
         .correct-questions-list {
             max-height: 300px;
             overflow-y: auto;
         }
         .dropdown-header {
             color: #6c757d;
             font-weight: 600;
             font-size: 0.875rem;
             padding: 0.5rem 1rem;
             background-color: #f8f9fa;
             border-bottom: 1px solid #dee2e6;
         }
         .dropdown-header i {
             margin-right: 0.5rem;
             color: #667eea;
         }
         
         /* Styles pour corriger le décalage du score de la page */
         .page-score-summary .row {
             margin: 0;
             display: flex;
             justify-content: space-between;
             align-items: center;
         }
         
         .page-score-summary .col-md-2 {
             padding: 0 8px;
             flex: 1;
             text-align: center;
             min-width: 0;
         }
         
         .page-score-summary h4 {
             font-size: 1.4rem;
             margin-bottom: 0.25rem;
             font-weight: bold;
         }
         
         .page-score-summary small {
             font-size: 0.7rem;
             display: block;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
         }
         
         /* Styles pour le chronomètre flottant */
         .timer-container {
             position: fixed;
             bottom: 20px;
             right: 20px;
             background: rgba(255, 255, 255, 0.95);
             backdrop-filter: blur(10px);
             border-radius: 15px;
             box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
             padding: 15px;
             min-width: 180px;
             z-index: 1000;
             border: 1px solid rgba(102, 126, 234, 0.2);
             transition: all 0.3s ease;
         }
         
         .timer-container:hover {
             transform: translateY(-2px);
             box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
         }
         
         .timer-header {
             display: flex;
             align-items: center;
             justify-content: space-between;
             margin-bottom: 8px;
             font-size: 0.9rem;
             font-weight: 600;
             color: #667eea;
         }
         
         .timer-header i {
             margin-right: 5px;
         }
         
         .timer-pause-btn {
             background: none;
             border: none;
             color: #667eea;
             cursor: pointer;
             padding: 5px;
             border-radius: 50%;
             transition: all 0.2s ease;
             width: 30px;
             height: 30px;
             display: flex;
             align-items: center;
             justify-content: center;
         }
         
         .timer-pause-btn:hover {
             background: rgba(102, 126, 234, 0.1);
             transform: scale(1.1);
         }
         
         .timer-display {
             font-family: 'Courier New', monospace;
             font-size: 1.2rem;
             font-weight: bold;
             text-align: center;
             color: #333;
             background: #f8f9fa;
             padding: 8px 12px;
             border-radius: 8px;
             border: 1px solid #e9ecef;
         }
         
         /* Styles pour la carte des boutons d'action flottante */
         .action-container {
             position: fixed;
             bottom: 160px;
             right: 20px;
             background: var(--card-bg, rgba(255, 255, 255, 0.95));
             backdrop-filter: blur(10px);
             border-radius: 15px;
             box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
             padding: 15px;
             min-width: 80px;
             z-index: 1000;
             border: 1px solid var(--border-color, rgba(102, 126, 234, 0.2));
             transition: all 0.3s ease;
         }
         
         .action-container:hover {
             transform: translateY(-2px);
             box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
         }
         
         .action-header {
             display: flex;
             align-items: center;
             justify-content: center;
             margin-bottom: 10px;
             font-size: 0.9rem;
             font-weight: 600;
             color: var(--text-primary, #667eea);
         }
         
         .action-header i {
             margin-right: 5px;
         }
         
         .action-buttons-vertical {
             display: flex;
             flex-direction: column;
             gap: 8px;
             align-items: center;
         }
         
         .action-btn-vertical {
             background: var(--btn-bg, rgba(255, 255, 255, 0.9));
             border: 1px solid var(--btn-border, rgba(0, 0, 0, 0.1));
             border-radius: 8px;
             padding: 10px;
             color: var(--text-primary, #333);
             cursor: pointer;
             transition: all 0.2s ease;
             font-size: 1rem;
             width: 50px;
             height: 50px;
             display: fled;
             align-items: center;
             justify-content: center;
         }
         
         .action-btn-vertical:hover {
             transform: scale(1.1);
             box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
         }
         
         .action-btn-vertical.shuffle-btn {
             color: var(--shuffle-color, #6c757d);
             border-color: var(--shuffle-border, rgba(108, 117, 125, 0.3));
         }
         
         .action-btn-vertical.shuffle-btn:hover {
             background: var(--shuffle-hover-bg, rgba(108, 117, 125, 0.1));
             color: var(--shuffle-hover-color, #495057);
         }
         
         .action-btn-vertical.score-btn {
             color: var(--score-color, #17a2b8);
             border-color: var(--score-border, rgba(23, 162, 184, 0.3));
         }
         
         .action-btn-vertical.score-btn:hover {
             background: var(--score-hover-bg, rgba(23, 162, 184, 0.1));
             color: var(--score-hover-color, #138496);
         }
         
         .action-btn-vertical.reset-btn {
             color: var(--reset-color, #dc3545);
             border-color: var(--reset-border, rgba(220, 53, 69, 0.3));
         }
         
         .action-btn-vertical.reset-btn:hover {
             background: var(--reset-hover-bg, rgba(220, 53, 69, 0.1));
             color: var(--reset-hover-color, #c82333);
         }
         
         /* Styles pour la carte des thèmes flottante */
         .theme-container {
             position: fixed;
             bottom: 160px;
             left: 20px;
             background: rgba(255, 255, 255, 0.95);
             backdrop-filter: blur(10px);
             border-radius: 15px;
             box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
             padding: 15px;
             min-width: 80px;
             z-index: 1000;
             border: 1px solid rgba(102, 126, 234, 0.2);
             transition: all 0.3s ease;
         }
         
         .theme-container:hover {
             transform: translateY(-2px);
             box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
         }
         
         .theme-header {
             display: flex;
             align-items: center;
             justify-content: center;
             margin-bottom: 10px;
             font-size: 0.9rem;
             font-weight: 600;
             color: #667eea;
         }
         
         .theme-header i {
             margin-right: 5px;
         }
         
         .theme-buttons-vertical {
             display: flex;
             flex-direction: column;
             gap: 8px;
             align-items: center;
         }
         
         .theme-btn-vertical {
             background: rgba(255, 255, 255, 0.9);
             border: 1px solid rgba(102, 126, 234, 0.2);
             border-radius: 8px;
             padding: 10px;
             color: #667eea;
             cursor: pointer;
             transition: all 0.2s ease;
             font-size: 1rem;
             width: 50px;
             height: 50px;
             display: flex;
             align-items: center;
             justify-content: center;
         }
         
         .theme-btn-vertical:hover {
             background: rgba(102, 126, 234, 0.1);
             transform: scale(1.1);
             color: #5a6fd8;
         }
         
         .theme-btn-vertical.active {
             background: #667eea;
             color: white;
             border-color: #667eea;
         }
         

         
         /* Responsive pour mobile */
         @media (max-width: 768px) {
             .theme-container {
                 bottom: 10px;
                 left: 10px;
                 right: 10px;
                 min-width: auto;
                 max-width: 120px;
                 margin: 0 auto;
             }
             
             .action-container {
                 bottom: 10px;
                 right: 10px;
                 left: 10px;
                 min-width: auto;
                 max-width: 120px;
                 margin: 0 auto;
             }
             
             .timer-container {
                 bottom: 10px;
                 right: 10px;
                 left: 10px;
                 min-width: auto;
                 max-width: 200px;
                 margin: 0 auto;
             }
             
             .timer-display {
                 font-size: 1rem;
                 padding: 6px 10px;
             }
             
             .floating-buttons {
                 bottom: 10px;
                 left: 10px;
                 right: 10px;
                 flex-direction: column;
                 gap: 10px;
             }
             
             .floating-btn {
                 width: 100%;
                 justify-content: center;
             }
         }
         
                 /* Styles pour les boutons flottants */
        .floating-buttons {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
         
         .floating-btn {
             background: rgba(255, 255, 255, 0.95);
             backdrop-filter: blur(10px);
             border: 1px solid rgba(0, 0, 0, 0.1);
             border-radius: 25px;
             padding: 12px 20px;
             color: #333;
             text-decoration: none;
             font-weight: 500;
             box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
             transition: all 0.3s ease;
             display: flex;
             align-items: center;
             gap: 8px;
         }
         
         .floating-btn:hover {
             transform: translateY(-2px);
             box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
             text-decoration: none;
             color: #333;
         }
         
         .floating-btn.home {
             background: linear-gradient(45deg, #667eea, #764ba2);
             color: white;
             border: none;
         }
         
         .floating-btn.home:hover {
             background: linear-gradient(45deg, #5a6fd8, #6a4190);
             color: white;
         }
         
         .floating-btn.logout {
             background: linear-gradient(45deg, #dc3545, #c82333);
             color: white;
             border: none;
         }
         
         .floating-btn.logout:hover {
             background: linear-gradient(45deg, #c82333, #bd2130);
             color: white;
         }
    </style>
</head>
<body>


    <div class="quiz-container">
        <div class="text-center mb-4">
            <h1 id="qcm-title"><i class="fas fa-play"></i> Chargement...</h1>
            <p class="text-muted" id="qcm-description">Chargement du QCM...</p>
        </div>

        <!-- Barre de progression -->
        <div class="progress mb-4" style="height: 10px;">
            <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>

        <!-- Navigation par pages -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="d-flex align-items-center">
                    <span class="mr-3"><strong>Page :</strong></span>
                    <div class="btn-group" role="group" id="page-selector">
                        <!-- Les boutons de pages seront générés ici -->
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-right">
                    <span class="badge badge-info" id="page-info">Page 1 sur 1</span>
                </div>
            </div>
        </div>

        <!-- Informations du quiz -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="text-center">
                    <h5 id="current-page">0</h5>
                    <small class="text-muted">Page actuelle</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h5 id="total-pages">0</h5>
                    <small class="text-muted">Total pages</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h5 id="correct-answers">0</h5>
                    <small class="text-muted">Réponses correctes</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h5 id="score-percentage">0%</h5>
                    <small class="text-muted">Score</small>
                </div>
            </div>
        </div>

        <!-- Zone de questions par page -->
        <div id="page-container">
            <div class="text-center">
                <p>Chargement du QCM...</p>
            </div>
        </div>

        <!-- Boutons de navigation -->
        <div class="text-center mt-4">
            <!-- Bouton mélanger -->
            <button class="btn btn-outline-secondary mb-3" onclick="shuffleCurrentPageQuestions()" title="Mélanger l'ordre des questions">
                <i class="fas fa-random"></i> Mélanger les questions
            </button>
            
            <!-- Bouton score par page -->
            <button class="btn btn-outline-info mb-3" id="score-btn-bottom" onclick="togglePageScore()" title="Voir le score de cette page">
                <i class="fas fa-chart-pie"></i> Score de la page
            </button>
            
            <!-- Bouton réinitialiser les réponses de la page -->
            <button class="btn btn-outline-danger mb-3" onclick="resetPageAnswers()" title="Réinitialiser les réponses de cette page">
                <i class="fas fa-undo"></i> Réinitialiser les réponses
            </button>
            
            <!-- Boutons de navigation -->
            <div class="mt-3">
                <button class="btn btn-secondary" id="prev-btn" onclick="previousPage()" style="display: none;">
                    <i class="fas fa-chevron-left"></i> Page précédente
                </button>
                <button class="btn btn-qcm" id="next-btn" onclick="nextPage()">
                    Page suivante <i class="fas fa-chevron-right"></i>
                </button>
                <button class="btn btn-success" id="finish-btn" onclick="finishQuiz()" style="display: none;">
                    <i class="fas fa-check"></i> Terminer l'examen
                </button>
            </div>
        </div>

        <!-- Navigation par pages en bas -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-center align-items-center">
                    <span class="mr-3"><strong>Aller à la page :</strong></span>
                    <div class="btn-group" role="group" id="page-selector-bottom">
                        <!-- Les boutons de pages seront générés ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Résultats -->
        <div id="results-container" style="display: none;">
            <div class="text-center">
                <h3>Résultats du Quiz</h3>
                <div class="alert alert-info">
                    <h4 id="final-score">Score: 0%</h4>
                    <p id="final-message">Message de résultat</p>
                </div>
                <button class="btn btn-qcm" onclick="restartQuiz()">
                    <i class="fas fa-redo"></i> Recommencer
                </button>
                <a href="index.html" class="btn btn-secondary">
                    <i class="fas fa-home"></i> Retour à l'accueil
                </a>
            </div>
        </div>
    </div>

         <!-- Scripts -->
     <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
     <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script>
        let currentQCM = null;
        let currentPageIndex = 0;
        let userAnswers = {};
        let quizCompleted = false;
                 let showAnswers = {};
        let showExplanations = {};
         let pageScoreVisible = false;
        let completedPages = new Set(); // Pour suivre les pages complétées
        let shuffledQuestions = {}; // Pour stocker les questions mélangées par page

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkSession()) {
                window.location.href = 'login.html';
                return;
            }
            
            updateUserDisplay();
            loadQCMFromURL();
        });

        function checkSession() {
            const sessionData = sessionStorage.getItem('mcqed_session');
            if (!sessionData) {
                return false;
            }

            try {
                const session = JSON.parse(sessionData);
                const now = Date.now();
                
                if (session.expiresAt <= now) {
                    sessionStorage.removeItem('mcqed_session');
                    return false;
                }
                
                return true;
            } catch (e) {
                sessionStorage.removeItem('mcqed_session');
                return false;
            }
        }

        function updateUserDisplay() {
            // Cette fonction n'est plus nécessaire car nous n'affichons plus le nom d'utilisateur
            // Gardée pour compatibilité mais ne fait rien
        }

        function logout() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                sessionStorage.removeItem('mcqed_session');
                window.location.href = 'login.html';
            }
        }

        function loadQCMFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const qcmId = urlParams.get('qcm');
            
            if (!qcmId) {
                alert('Aucun QCM spécifié');
                window.location.href = 'index.html';
                return;
            }

            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            currentQCM = qcms.find(qcm => qcm.id === qcmId);
            
            if (!currentQCM) {
                alert('QCM non trouvé');
                window.location.href = 'index.html';
                return;
            }

            // Vérification des questions - gérer les deux structures (avec et sans pages)
            let hasQuestions = false;
            if (currentQCM.pages && currentQCM.pages.length > 0) {
                hasQuestions = currentQCM.pages.some(page => page.questions && page.questions.length > 0);
            } else if (currentQCM.questions) {
                hasQuestions = currentQCM.questions.length > 0;
            }
            
            if (!hasQuestions) {
                alert('Ce QCM ne contient aucune question');
                window.location.href = 'index.html';
                return;
            }

            // Si le QCM n'a pas de pages, créer une structure avec pages
            if (!currentQCM.pages && currentQCM.questions) {
                currentQCM.pages = [{
                    id: 'default-page',
                    name: 'Page principale',
                    questions: currentQCM.questions
                }];
            }

            // Afficher les informations du QCM
            document.getElementById('qcm-title').innerHTML = `<i class="fas fa-play"></i> ${currentQCM.title}`;
            document.getElementById('qcm-description').textContent = currentQCM.description;
            document.getElementById('total-pages').textContent = currentQCM.pages.length;

            // Ajouter des explications de test aux questions qui n'en ont pas (temporaire)
            addTestExplanations();

            // Créer le sélecteur de pages
            createPageSelector();
            
            // Afficher la première page
            displayPage(0);
            updateProgress();
        }

        function displayPage(pageIndex) {
            if (!currentQCM || !currentQCM.pages[pageIndex]) {
                return;
            }

            const page = currentQCM.pages[pageIndex];
            const container = document.getElementById('page-container');
            
            document.getElementById('current-page').textContent = pageIndex + 1;
            
            // Supprimer TOUS les résumés de score de page qui pourraient exister
            const allSummaries = document.querySelectorAll('.page-score-summary');
            allSummaries.forEach(summary => summary.remove());
            
            // Réinitialiser l'état du score de la page
            pageScoreVisible = false;
            
            // Ne pas réinitialiser les explications à chaque changement de page pour permettre la persistance
            // showExplanations = {};
            
                         // Obtenir les questions mélangées pour cette page
             let questionsToDisplay = shuffledQuestions[pageIndex] || page.questions;
             
             let questionsHTML = '';
             questionsToDisplay.forEach((question, questionIndex) => {
                 // Calculer le numéro global de la question (en comptant toutes les pages précédentes)
                 let globalQuestionNumber = 0;
                 
                 // Ajouter le nombre de questions de toutes les pages précédentes
                 for (let i = 0; i < pageIndex; i++) {
                     globalQuestionNumber += currentQCM.pages[i].questions.length;
                 }
                 
                 // Ajouter la position de cette question dans la page actuelle
                 const questionPositionInPage = page.questions.findIndex(q => q.id === question.id) + 1;
                 globalQuestionNumber += questionPositionInPage;
                 
                 const displayNumber = globalQuestionNumber;
                                 let optionsHTML = '';
                 question.options.forEach((option, optionIndex) => {
                     const optionLetter = option.id.toUpperCase();
                     const isSelected = userAnswers[question.id] && userAnswers[question.id].includes(optionLetter);
                     let selectedClass = isSelected ? 'selected' : '';
                     
                     // Ajouter les classes et styles pour les réponses correctes/incorrectes si on affiche les réponses
                     let inlineStyle = '';
                     if (showAnswers[question.id]) {
                         // Normaliser les réponses correctes pour la comparaison (convertir en minuscules)
                         const normalizedCorrectAnswers = question.correctAnswers.map(answer => answer.toLowerCase());
                         
                         if (normalizedCorrectAnswers.includes(option.id.toLowerCase())) {
                             selectedClass = 'correct'; // Toujours vert pour les bonnes réponses
                             inlineStyle = 'style="border-color: #28a745 !important; background: #d4edda !important; color: #155724 !important;"';
                         } else if (isSelected && !normalizedCorrectAnswers.includes(option.id.toLowerCase())) {
                             selectedClass = 'incorrect'; // Rouge pour les mauvaises réponses sélectionnées
                             inlineStyle = 'style="border-color: #dc3545 !important; background: #f8d7da !important; color: #721c24 !important;"';
                         }
                         // Si l'option n'est pas sélectionnée et pas correcte, elle garde selectedClass = '' (neutre)
                     }
                     
                     optionsHTML += `
                         <div class="option-item ${selectedClass}" ${inlineStyle} onclick="selectOption('${optionLetter}', '${question.id}')">
                             <strong>${optionLetter}.</strong> ${option.text}
                         </div>
                     `;
                 });
                 
                 let explanationHTML = '';
                 if (showExplanations[question.id] && question.explanation && question.explanation.trim() !== '') {
                     explanationHTML = `
                         <div class="explanation-box">
                             <strong><i class="fas fa-lightbulb"></i> Explication :</strong><br>
                             ${question.explanation}
                         </div>
                     `;
                 }
                 
                 // Boutons pour voir la réponse et l'explication de cette question spécifique
                 let showAnswerButtons = '';
                 const hasAnswered = userAnswers[question.id] && userAnswers[question.id].length > 0;
                 if (hasAnswered) {
                     let buttonsHTML = '';
                     
                     // Bouton "Voir la réponse" si pas encore affiché
                     if (!showAnswers[question.id]) {
                         buttonsHTML += `
                             <button class="btn btn-outline-info btn-sm mr-2" onclick="showQuestionAnswer('${question.id}')" title="Voir la réponse de cette question">
                                 <i class="fas fa-check-circle"></i> Voir la réponse
                             </button>
                         `;
                     }
                     
                     // Bouton "Voir l'explication" seulement si la réponse est affichée ET si pas encore affiché et si explication existe
                     if (showAnswers[question.id] && !showExplanations[question.id] && question.explanation && question.explanation.trim() !== '') {
                         buttonsHTML += `
                             <button class="btn btn-outline-warning btn-sm" onclick="showQuestionExplanation('${question.id}')" title="Voir l'explication de cette question">
                                 <i class="fas fa-lightbulb"></i> Voir l'explication
                             </button>
                         `;
                     }
                     
                     if (buttonsHTML) {
                         showAnswerButtons = `<div class="mt-3">${buttonsHTML}</div>`;
                     }
                 }
                 
                 // Affichage des bonnes réponses (lettres) si demandé
                 let correctAnswersHTML = '';
                 if (showAnswers[question.id]) {
                     const correctLetters = question.correctAnswers.map(answer => answer.toUpperCase()).join(', ');
                     correctAnswersHTML = `
                         <div class="alert alert-success mt-3">
                             <strong><i class="fas fa-check-circle"></i> Bonne(s) réponse(s) :</strong> ${correctLetters}
                         </div>
                     `;
                 }
                 
                 questionsHTML += `
                     <div class="question-card">
                         <h5 class="mb-3">Question ${displayNumber}</h5>
                         <p class="mb-4">${question.text}</p>
                         <div class="options-container">
                             ${optionsHTML}
                         </div>
                         ${question.type === 'multiple' ? '<small class="text-muted">Sélectionnez toutes les réponses correctes</small>' : ''}
                         ${showAnswerButtons}
                         ${correctAnswersHTML}
                         ${explanationHTML}
                     </div>
                 `;
            });
            
                         // Créer l'indicateur d'ordre des questions
             let orderIndicator = '';
             if (shuffledQuestions[pageIndex]) {
                 const order = questionsToDisplay.map(q => {
                     // Calculer le numéro global pour l'indicateur d'ordre
                     let globalQuestionNumber = 0;
                     
                     // Ajouter le nombre de questions de toutes les pages précédentes
                     for (let i = 0; i < pageIndex; i++) {
                         globalQuestionNumber += currentQCM.pages[i].questions.length;
                     }
                     
                     // Ajouter la position de cette question dans la page actuelle
                     const questionPositionInPage = page.questions.findIndex(originalQ => originalQ.id === q.id) + 1;
                     globalQuestionNumber += questionPositionInPage;
                     
                     return globalQuestionNumber;
                 });
                 orderIndicator = `<small class="text-muted d-block mt-2"><i class="fas fa-random"></i> Ordre : ${order.join(' - ')}</small>`;
             }
             
             container.innerHTML = `
                 <div class="page-header">
                     <div>
                         <div class="page-indicator">
                             Page ${pageIndex + 1} sur ${currentQCM.pages.length} - ${page.name}
                         </div>
                         <h4>${page.name}</h4>
                         <p class="text-muted">${page.questions.length} question(s) dans cette page</p>
                         ${orderIndicator}
                     </div>
                 </div>
                 ${questionsHTML}
             `;
            
            // Vérifier la complétion de la page
            checkPageCompletion();
            
            updateNavigationButtons();
            updateScore();
            updatePageSelector();
            updateScoreButton();
        }

        function selectOption(optionLetter, questionId) {
            if (showAnswers[questionId]) return; // Empêcher la sélection si on affiche les réponses pour cette question
            
            const question = currentQCM.pages[currentPageIndex].questions.find(q => q.id === questionId);
            
            if (!userAnswers[questionId]) {
                userAnswers[questionId] = [];
            }
            
            if (question.type === 'single') {
                userAnswers[questionId] = [optionLetter];
            } else {
                const index = userAnswers[questionId].indexOf(optionLetter);
                if (index > -1) {
                    userAnswers[questionId].splice(index, 1);
                } else {
                    userAnswers[questionId].push(optionLetter);
                }
            }
            
            // Vérifier si la page est complétée
            checkPageCompletion();
            
            displayPage(currentPageIndex);
            updatePageSelector();
        }

        function previousPage() {
            if (currentPageIndex > 0) {
                currentPageIndex--;
                displayPage(currentPageIndex);
                updateProgress();
                updatePageSelector();
            }
        }

        function nextPage() {
            if (currentPageIndex < currentQCM.pages.length - 1) {
                currentPageIndex++;
                displayPage(currentPageIndex);
                updateProgress();
                updatePageSelector();
            } else {
                finishQuiz();
            }
        }

        function updateNavigationButtons() {
            // Gérer l'affichage du bouton précédent
            if (currentPageIndex === 0) {
                document.getElementById('prev-btn').style.display = 'none';
            } else {
                document.getElementById('prev-btn').style.display = 'inline-block';
            }
            
            if (currentPageIndex === currentQCM.pages.length - 1) {
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('finish-btn').style.display = 'inline-block';
            } else {
                document.getElementById('next-btn').style.display = 'inline-block';
                document.getElementById('finish-btn').style.display = 'none';
            }
        }

        function createPageSelector() {
            // Créer le sélecteur en haut
            const selectorTop = document.getElementById('page-selector');
            selectorTop.innerHTML = '';
            
            // Créer le sélecteur en bas
            const selectorBottom = document.getElementById('page-selector-bottom');
            selectorBottom.innerHTML = '';
            
            for (let i = 0; i < currentQCM.pages.length; i++) {
                // Bouton pour le sélecteur en haut
                const pageBtnTop = document.createElement('button');
                pageBtnTop.type = 'button';
                pageBtnTop.className = 'btn btn-outline-primary page-btn';
                pageBtnTop.textContent = i + 1;
                pageBtnTop.onclick = () => goToPage(i);
                pageBtnTop.title = `Aller à la page ${i + 1}: ${currentQCM.pages[i].name}`;
                selectorTop.appendChild(pageBtnTop);
                
                // Bouton pour le sélecteur en bas
                const pageBtnBottom = document.createElement('button');
                pageBtnBottom.type = 'button';
                pageBtnBottom.className = 'btn btn-outline-primary page-btn';
                pageBtnBottom.textContent = i + 1;
                pageBtnBottom.onclick = () => goToPage(i);
                pageBtnBottom.title = `Aller à la page ${i + 1}: ${currentQCM.pages[i].name}`;
                selectorBottom.appendChild(pageBtnBottom);
            }
            
            updatePageSelector();
        }
        
                 function checkPageCompletion() {
             const currentPage = currentQCM.pages[currentPageIndex];
             const pageQuestions = currentPage.questions; // Toujours utiliser les questions originales pour la vérification
             
             // Vérifier si toutes les questions de la page ont été répondues
             const allAnswered = pageQuestions.every(question => {
                 const userAnswer = userAnswers[question.id];
                 return userAnswer && userAnswer.length > 0;
             });
             
             if (allAnswered) {
                 completedPages.add(currentPageIndex);
             } else {
                 completedPages.delete(currentPageIndex);
             }
         }
        
        function updatePageSelector() {
            // Mettre à jour les boutons du sélecteur en haut
            const pageButtonsTop = document.querySelectorAll('#page-selector .page-btn');
            pageButtonsTop.forEach((btn, index) => {
                btn.classList.remove('active', 'completed');
                
                if (index === currentPageIndex) {
                    btn.classList.add('active');
                } else if (completedPages.has(index)) {
                    btn.classList.add('completed');
                }
            });
            
            // Mettre à jour les boutons du sélecteur en bas
            const pageButtonsBottom = document.querySelectorAll('#page-selector-bottom .page-btn');
            pageButtonsBottom.forEach((btn, index) => {
                btn.classList.remove('active', 'completed');
                
                if (index === currentPageIndex) {
                    btn.classList.add('active');
                } else if (completedPages.has(index)) {
                    btn.classList.add('completed');
                }
            });
            
            // Mettre à jour l'indicateur de page
            document.getElementById('page-info').textContent = `Page ${currentPageIndex + 1} sur ${currentQCM.pages.length}`;
        }
        
        function goToPage(pageIndex) {
            if (pageIndex >= 0 && pageIndex < currentQCM.pages.length) {
                currentPageIndex = pageIndex;
                displayPage(currentPageIndex);
                updateProgress();
                updatePageSelector();
            }
        }
        
                 function shuffleCurrentPageQuestions() {
             const currentPage = currentQCM.pages[currentPageIndex];
             
             // Créer une copie des questions pour les mélanger
             const questionsCopy = [...currentPage.questions];
             
             // Mélanger les questions
             for (let i = questionsCopy.length - 1; i > 0; i--) {
                 const j = Math.floor(Math.random() * (i + 1));
                 [questionsCopy[i], questionsCopy[j]] = [questionsCopy[j], questionsCopy[i]];
             }
             
             // Sauvegarder les questions mélangées
             shuffledQuestions[currentPageIndex] = questionsCopy;
             
             // Créer l'indicateur d'ordre pour la notification
             const order = questionsCopy.map(q => {
                 const originalIndex = currentPage.questions.findIndex(originalQ => originalQ.id === q.id) + 1;
                 return originalIndex;
             });
             
             // Réafficher la page avec les questions mélangées
             displayPage(currentPageIndex);
             
             // Afficher une notification avec le nouvel ordre
             showNotification(`Questions mélangées ! Nouvel ordre : ${order.join(' - ')}`, 'info');
         }
         
         function updateProgress() {
             const progress = ((currentPageIndex + 1) / currentQCM.pages.length) * 100;
             document.getElementById('progress-bar').style.width = progress + '%';
         }

                 function togglePageScore() {
             if (pageScoreVisible) {
                 hidePageScore();
             } else {
                 showPageScore();
             }
         }
         
         function showPageScore() {
             const currentPage = currentQCM.pages[currentPageIndex];
             const pageQuestions = currentPage.questions;
             
             let correct = 0;
             let total = 0;
             let answered = 0;
             
             pageQuestions.forEach(question => {
                 const userAnswer = userAnswers[question.id] || [];
                 const correctAnswer = question.correctAnswers.map(a => a.toUpperCase());
                 
                 if (userAnswer.length > 0) {
                     answered++;
                     if (userAnswer.length === correctAnswer.length && 
                         userAnswer.every(answer => correctAnswer.includes(answer.toUpperCase()))) {
                         correct++;
                     }
                 }
                 total++;
             });
             
             // Considérer les questions non répondues comme des mauvaises réponses pour le score
             const unanswered = total - answered;
             const incorrect = answered - correct + unanswered;
             const percentage = Math.round((correct / total) * 100);
             
             // Afficher les réponses pour toutes les questions de la page
             pageQuestions.forEach(question => {
                 showAnswers[question.id] = true;
             });
             
             // Réafficher la page avec les résultats
             displayPage(currentPageIndex);
             
             // Créer et afficher le résumé des résultats
             let summaryHTML = '';
             const passingThreshold = currentQCM.passingThreshold || 60;
             const scoreClass = percentage >= passingThreshold ? 'success' : percentage >= (passingThreshold - 20) ? 'warning' : 'danger';
             
             if (answered === 0) {
                 summaryHTML = `
                     <div class="alert alert-danger">
                         <h5><i class="fas fa-exclamation-triangle"></i> Aucune question répondue</h5>
                         <p>Vous n'avez répondu à aucune question sur cette page. Toutes les questions sont considérées comme mauvaises réponses.</p>
                         <p><strong>Score :</strong> 0% (${correct}/${total} bonnes réponses)</p>
                     </div>
                 `;
             } else {
                 summaryHTML = `
                     <div class="alert alert-${scoreClass}">
                         <h5><i class="fas fa-chart-pie"></i> Résultats de la page</h5>
                         <div class="row">
                             <div class="col-md-2">
                                 <h4 class="text-center">${percentage}%</h4>
                                 <p class="text-center"><small>Score</small></p>
                             </div>
                             <div class="col-md-2">
                                 <h4 class="text-center text-success">${correct}</h4>
                                 <p class="text-center"><small>Bonnes réponses</small></p>
                             </div>
                             <div class="col-md-2">
                                 <h4 class="text-center text-danger">${answered - correct}</h4>
                                 <p class="text-center"><small>Mauvaises réponses</small></p>
                             </div>
                             <div class="col-md-2">
                                 <h4 class="text-center text-warning">${unanswered}</h4>
                                 <p class="text-center"><small>Non répondues</small></p>
                             </div>
                             <div class="col-md-2">
                                 <h4 class="text-center text-info">${total}</h4>
                                 <p class="text-center"><small>Questions totales</small></p>
                             </div>
                         </div>
                         <div class="mt-3">
                             <button class="btn btn-outline-secondary btn-sm" onclick="hidePageScore()">
                                 <i class="fas fa-eye-slash"></i> Masquer les résultats
                             </button>
                         </div>
                     </div>
                 `;
             }
             
                           // Insérer le résumé après le bouton score (en bas de la page)
              const scoreBtnBottom = document.getElementById('score-btn-bottom');
              
              // Supprimer TOUS les résumés existants
              const allSummaries = document.querySelectorAll('.page-score-summary');
              allSummaries.forEach(summary => summary.remove());
              
              // Créer un conteneur pour le résumé avec une classe spécifique
              const summaryContainer = document.createElement('div');
              summaryContainer.className = 'page-score-summary';
              summaryContainer.innerHTML = summaryHTML;
              
              // Insérer le résumé après le bouton score en bas
              if (scoreBtnBottom) {
                  scoreBtnBottom.parentNode.insertBefore(summaryContainer, scoreBtnBottom.nextSibling);
              }
             
             // Mettre à jour l'état et le bouton
             pageScoreVisible = true;
             updateScoreButton();
         }
         
         function hidePageScore() {
             const currentPage = currentQCM.pages[currentPageIndex];
             
             // Masquer les réponses pour toutes les questions de la page
             currentPage.questions.forEach(question => {
                 showAnswers[question.id] = false;
             });
             
                           // Supprimer TOUS les résumés
              const allSummaries = document.querySelectorAll('.page-score-summary');
              allSummaries.forEach(summary => summary.remove());
             
             // Réafficher la page sans les résultats
             displayPage(currentPageIndex);
             
             // Mettre à jour l'état et le bouton
             pageScoreVisible = false;
             updateScoreButton();
         }
         
         function updateScoreButton() {
             const scoreBtnTop = document.getElementById('score-btn-top');
             const scoreBtnBottom = document.getElementById('score-btn-bottom');
             
             if (pageScoreVisible) {
                 if (scoreBtnTop) {
                     scoreBtnTop.innerHTML = '<i class="fas fa-eye-slash"></i>';
                     scoreBtnTop.title = 'Masquer le score de cette page';
                 }
                 if (scoreBtnBottom) {
                     scoreBtnBottom.innerHTML = '<i class="fas fa-eye-slash"></i> Masquer le score';
                     scoreBtnBottom.title = 'Masquer le score de cette page';
                 }
             } else {
                 if (scoreBtnTop) {
                     scoreBtnTop.innerHTML = '<i class="fas fa-chart-pie"></i>';
                     scoreBtnTop.title = 'Voir le score de cette page';
                 }
                 if (scoreBtnBottom) {
                     scoreBtnBottom.innerHTML = '<i class="fas fa-chart-pie"></i> Score de la page';
                     scoreBtnBottom.title = 'Voir le score de cette page';
                 }
             }
         }
         
                 function showQuestionAnswer(questionId) {
            showAnswers[questionId] = true;
            displayPage(currentPageIndex);
        }
        
        function showQuestionExplanation(questionId) {
            showExplanations[questionId] = true;
            displayPage(currentPageIndex);
        }
        
        function addTestExplanations() {
            // Ajouter des explications de test aux questions qui n'en ont pas
            currentQCM.pages.forEach(page => {
                page.questions.forEach(question => {
                    if (!question.explanation || question.explanation.trim() === '') {
                        question.explanation = `Explication de test pour la question "${question.text.substring(0, 50)}..."`;
                    }
                });
            });
        }
         
                   function resetPageAnswers() {
              const currentPage = currentQCM.pages[currentPageIndex];
              
              // Supprimer les réponses de la page courante
              currentPage.questions.forEach(question => {
                  delete userAnswers[question.id];
              });
              
              // Réinitialiser l'affichage des réponses et explications
              showAnswers = {};
              showExplanations = {};
              
              // Si le score de la page est affiché, le masquer
              if (pageScoreVisible) {
                  // Masquer les réponses pour toutes les questions de la page
                  currentPage.questions.forEach(question => {
                      showAnswers[question.id] = false;
                  });
                  
                  // Supprimer TOUS les résumés
                  const allSummaries = document.querySelectorAll('.page-score-summary');
                  allSummaries.forEach(summary => summary.remove());
                  
                  pageScoreVisible = false;
              }
              
              // Réafficher la page
              displayPage(currentPageIndex);
              
              // Mettre à jour le bouton
              updateScoreButton();
              
              // Afficher une notification
              showNotification('Réponses de la page réinitialisées !', 'success');
          }

                         function finishQuiz() {
            // Arrêter le chronomètre
            stopTimer();
            
            const totalScore = calculateScore();
            const totalQuestions = getTotalQuestions();
            const totalPercentage = Math.round((totalScore.correct / totalQuestions) * 100);
            const elapsedTimeString = getElapsedTimeString();
            
            // Calculer le temps en minutes
            const timeInMinutes = Math.round(elapsedTime / 60000);
            
            // Sauvegarder les statistiques si la fonction est disponible
            if (typeof window.updateQCMStats === 'function') {
                window.updateQCMStats(currentQCM.id, totalPercentage, timeInMinutes);
            }
             
                           // Calculer le score par page
              let pageScores = [];
              currentQCM.pages.forEach((page, pageIndex) => {
                  let pageCorrect = 0;
                  let pageTotal = 0;
                  let incorrectQuestions = [];
                  let correctQuestions = [];
                  
                  page.questions.forEach((question, questionIndex) => {
                      const userAnswer = userAnswers[question.id] || [];
                      const correctAnswer = question.correctAnswers.map(a => a.toUpperCase());
                      
                      if (userAnswer.length === correctAnswer.length && 
                          userAnswer.every(answer => correctAnswer.includes(answer.toUpperCase()))) {
                          pageCorrect++;
                          // Ajouter les détails de la question correcte
                          correctQuestions.push({
                              questionNumber: questionIndex + 1,
                              questionText: question.text,
                              userAnswer: userAnswer.length > 0 ? userAnswer.join(', ') : 'Aucune réponse',
                              correctAnswer: correctAnswer.join(', '),
                              explanation: question.explanation || 'Aucune explication disponible'
                          });
                      } else {
                          // Ajouter les détails de la question incorrecte
                          incorrectQuestions.push({
                              questionNumber: questionIndex + 1,
                              questionText: question.text,
                              userAnswer: userAnswer.length > 0 ? userAnswer.join(', ') : 'Aucune réponse',
                              correctAnswer: correctAnswer.join(', '),
                              explanation: question.explanation || 'Aucune explication disponible'
                          });
                      }
                      pageTotal++;
                  });
                  
                  const pagePercentage = pageTotal > 0 ? Math.round((pageCorrect / pageTotal) * 100) : 0;
                  pageScores.push({
                      pageName: page.name,
                      correct: pageCorrect,
                      total: pageTotal,
                      percentage: pagePercentage,
                      correctQuestions: correctQuestions,
                      incorrectQuestions: incorrectQuestions
                  });
              });
             
             // Récupérer le seuil de réussite configuré (par défaut 60%)
             const passingThreshold = currentQCM.passingThreshold || 60;
             const isPassed = totalPercentage >= passingThreshold;
             
             // Créer le HTML pour les résultats détaillés
             let resultsHTML = `
                 <div class="alert alert-${isPassed ? 'success' : 'danger'} mb-4">
                     <h4 class="text-center">Score Total: ${totalPercentage}%</h4>
                     <p class="text-center">${totalScore.correct} bonnes réponses sur ${totalQuestions} questions</p>
                     <p class="text-center"><i class="fas fa-clock"></i> Temps total : ${elapsedTimeString}</p>
                     <p class="text-center">
                         <strong>Seuil de réussite requis : ${passingThreshold}%</strong>
                     </p>
                     <p class="text-center">
                         ${isPassed ? 
                         '<strong class="text-success"><i class="fas fa-trophy"></i> Félicitations ! Vous avez réussi l\'examen.</strong>' : 
                         '<strong class="text-danger"><i class="fas fa-times-circle"></i> Vous devez obtenir au moins ' + passingThreshold + '% pour réussir l\'examen.</strong>'}
                     </p>
                 </div>
                 
                 <h5 class="mb-3"><i class="fas fa-chart-bar"></i> Détail par page :</h5>
                 <div class="row">
             `;
             
                           pageScores.forEach((pageScore, index) => {
                  const scoreClass = pageScore.percentage >= passingThreshold ? 'success' : pageScore.percentage >= (passingThreshold - 20) ? 'warning' : 'danger';
                  resultsHTML += `
                      <div class="col-md-6 mb-3">
                          <div class="card border-${scoreClass}">
                              <div class="card-header bg-${scoreClass} text-white">
                                  <h6 class="mb-0"><i class="fas fa-file-alt"></i> Page ${index + 1}: ${pageScore.pageName}</h6>
                              </div>
                              <div class="card-body">
                                  <div class="row text-center mb-3">
                                      <div class="col-4">
                                          <h4 class="text-${scoreClass}">${pageScore.percentage}%</h4>
                                          <small>Score</small>
                                      </div>
                                      <div class="col-4">
                                          <h4 class="text-success">${pageScore.correct}</h4>
                                          <small>Bonnes</small>
                                      </div>
                                      <div class="col-4">
                                          <h4 class="text-info">${pageScore.total}</h4>
                                          <small>Total</small>
                                      </div>
                                  </div>
                                  
                                  ${pageScore.correctQuestions.length > 0 ? `
                                      <div class="mt-3">
                                          <h6 class="text-success"><i class="fas fa-check-circle"></i> Questions correctes (${pageScore.correctQuestions.length}) :</h6>
                                          <div class="correct-questions-list">
                                              ${pageScore.correctQuestions.map(correct => `
                                                  <div class="alert alert-success alert-sm mb-2">
                                                      <div class="d-flex justify-content-between align-items-start">
                                                          <strong>Question ${correct.questionNumber}</strong>
                                                          <small class="text-muted">${correct.questionText.length > 50 ? correct.questionText.substring(0, 50) + '...' : correct.questionText}</small>
                                                      </div>
                                                      <div class="mt-2">
                                                          <small><strong>Votre réponse :</strong> <span class="text-success">${correct.userAnswer}</span></small><br>
                                                          <small><strong>Réponse correcte :</strong> <span class="text-success">${correct.correctAnswer}</span></small>
                                                          ${correct.explanation !== 'Aucune explication disponible' ? `<br><small><strong>Explication :</strong> ${correct.explanation}</small>` : ''}
                                                      </div>
                                                  </div>
                                              `).join('')}
                                          </div>
                                      </div>
                                  ` : ''}
                                  
                                  ${pageScore.incorrectQuestions.length > 0 ? `
                                      <div class="mt-3">
                                          <h6 class="text-danger"><i class="fas fa-times-circle"></i> Questions incorrectes (${pageScore.incorrectQuestions.length}) :</h6>
                                          <div class="incorrect-questions-list">
                                              ${pageScore.incorrectQuestions.map(incorrect => `
                                                  <div class="alert alert-danger alert-sm mb-2">
                                                      <div class="d-flex justify-content-between align-items-start">
                                                          <strong>Question ${incorrect.questionNumber}</strong>
                                                          <small class="text-muted">${incorrect.questionText.length > 50 ? incorrect.questionText.substring(0, 50) + '...' : incorrect.questionText}</small>
                                                      </div>
                                                      <div class="mt-2">
                                                          <small><strong>Votre réponse :</strong> <span class="text-danger">${incorrect.userAnswer}</span></small><br>
                                                          <small><strong>Réponse correcte :</strong> <span class="text-success">${incorrect.correctAnswer}</span></small>
                                                          ${incorrect.explanation !== 'Aucune explication disponible' ? `<br><small><strong>Explication :</strong> ${incorrect.explanation}</small>` : ''}
                                                      </div>
                                                  </div>
                                              `).join('')}
                                          </div>
                                      </div>
                                  ` : ''}
                                  
                                  ${pageScore.correctQuestions.length === 0 && pageScore.incorrectQuestions.length === 0 ? `
                                      <div class="mt-3 text-center">
                                          <span class="badge badge-warning"><i class="fas fa-exclamation-triangle"></i> Aucune question répondue</span>
                                      </div>
                                  ` : ''}
                              </div>
                          </div>
                      </div>
                  `;
              });
             
             resultsHTML += `
                 </div>
                                   <div class="text-center mt-4">
                      <button class="btn btn-qcm" onclick="restartQuiz()">
                          <i class="fas fa-redo"></i> Recommencer
                      </button>
                      <button class="btn btn-outline-primary" onclick="exportToPDF()">
                          <i class="fas fa-file-pdf"></i> Exporter en PDF
                      </button>
                      <a href="index.html" class="btn btn-secondary">
                          <i class="fas fa-home"></i> Retour à l'accueil
                      </a>
                  </div>
             `;
             
             // Mettre à jour le conteneur de résultats
             document.getElementById('results-container').innerHTML = resultsHTML;
             
             // Masquer complètement tous les éléments de navigation et d'action
             document.getElementById('page-container').style.display = 'none';
             
             // Masquer les informations du quiz (barre de progression) - méthode plus agressive
             const quizInfo = document.querySelector('.row.mb-4');
             if (quizInfo) {
                 quizInfo.style.setProperty('display', 'none', 'important');
             }
             
             // Masquer aussi directement les éléments par leurs IDs avec !important
             const currentPageEl = document.getElementById('current-page');
             const totalPagesEl = document.getElementById('total-pages');
             const correctAnswersEl = document.getElementById('correct-answers');
             const scorePercentageEl = document.getElementById('score-percentage');
             
             if (currentPageEl && currentPageEl.parentElement && currentPageEl.parentElement.parentElement) {
                 currentPageEl.parentElement.parentElement.style.setProperty('display', 'none', 'important');
             }
             if (totalPagesEl && totalPagesEl.parentElement && totalPagesEl.parentElement.parentElement) {
                 totalPagesEl.parentElement.parentElement.style.setProperty('display', 'none', 'important');
             }
             if (correctAnswersEl && correctAnswersEl.parentElement && correctAnswersEl.parentElement.parentElement) {
                 correctAnswersEl.parentElement.parentElement.style.setProperty('display', 'none', 'important');
             }
             if (scorePercentageEl && scorePercentageEl.parentElement && scorePercentageEl.parentElement.parentElement) {
                 scorePercentageEl.parentElement.parentElement.style.setProperty('display', 'none', 'important');
             }
             
             // Masquer spécifiquement la section des informations du quiz
             const quizInfoSection = document.querySelector('.row.mb-4');
             if (quizInfoSection) {
                 quizInfoSection.style.setProperty('display', 'none', 'important');
             }
             
             // Masquer aussi les éléments individuels de la barre de progression
             const progressElements = document.querySelectorAll('.col-md-3');
             progressElements.forEach(el => {
                 if (el.textContent && (
                     el.textContent.includes('Page actuelle') ||
                     el.textContent.includes('Total pages') ||
                     el.textContent.includes('Réponses correctes') ||
                     el.textContent.includes('Score')
                 )) {
                     el.style.setProperty('display', 'none', 'important');
                 }
             });
             
             // Masquer les boutons de navigation et d'action
             const navigationSection = document.querySelector('.text-center.mt-4');
             if (navigationSection) {
                 navigationSection.style.display = 'none';
             }
             
             // Masquer la navigation par pages en bas
             const pageNavigation = document.querySelector('.row.mt-4');
             if (pageNavigation) {
                 pageNavigation.style.display = 'none';
             }
             
             // Masquer la barre de progression en haut
             const progressBar = document.querySelector('.progress-bar-container');
             if (progressBar) {
                 progressBar.style.display = 'none';
             }
             
             // Masquer le sélecteur de pages en haut
             const pageSelectorTop = document.getElementById('page-selector');
             if (pageSelectorTop) {
                 pageSelectorTop.style.display = 'none';
             }
             
             // Afficher uniquement les résultats
             document.getElementById('results-container').style.display = 'block';
             
             // S'assurer que le conteneur principal reste visible
             const mainContainer = document.querySelector('.container');
             if (mainContainer) {
                 mainContainer.style.setProperty('display', 'block', 'important');
             }
             
             quizCompleted = true;
         }

        function getTotalQuestions() {
            let total = 0;
            currentQCM.pages.forEach(page => {
                total += page.questions.length;
            });
            return total;
        }

        function calculateScore() {
            let correct = 0;
            let total = 0;
            
            currentQCM.pages.forEach(page => {
                page.questions.forEach(question => {
                    const userAnswer = userAnswers[question.id] || [];
                    const correctAnswer = question.correctAnswers.map(a => a.toUpperCase());
                    
                    if (userAnswer.length === correctAnswer.length && 
                        userAnswer.every(answer => correctAnswer.includes(answer.toUpperCase()))) {
                        correct++;
                    }
                    total++;
                });
            });
            
            return { correct, total };
        }

        function updateScore() {
            const score = calculateScore();
            document.getElementById('correct-answers').textContent = score.correct;
            document.getElementById('score-percentage').textContent = Math.round((score.correct / score.total) * 100) + '%';
        }

                 function showNotification(message, type) {
             const toast = document.createElement('div');
             toast.className = `alert alert-${type} position-fixed`;
             toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
             toast.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
             document.body.appendChild(toast);
             setTimeout(() => toast.remove(), 3000);
         }
         
         function restartQuiz() {
             currentPageIndex = 0;
             userAnswers = {};
             quizCompleted = false;
             showAnswers = {};
             pageScoreVisible = false;
             completedPages.clear(); // Réinitialiser les pages complétées
             shuffledQuestions = {}; // Réinitialiser les questions mélangées
             
             // Redémarrer le chronomètre
             stopTimer();
             setTimeout(startTimer, 1000);
             
             // Réafficher tous les éléments de navigation et d'action
             document.getElementById('page-container').style.display = 'block';
             
             // Réafficher les informations du quiz (barre de progression)
             const quizInfo = document.querySelector('.row.mb-4');
             if (quizInfo) {
                 quizInfo.style.setProperty('display', 'block', 'important');
             }
             
             // Réafficher aussi directement les éléments par leurs IDs avec !important
             const currentPageEl = document.getElementById('current-page');
             const totalPagesEl = document.getElementById('total-pages');
             const correctAnswersEl = document.getElementById('correct-answers');
             const scorePercentageEl = document.getElementById('score-percentage');
             
             if (currentPageEl && currentPageEl.parentElement && currentPageEl.parentElement.parentElement) {
                 currentPageEl.parentElement.parentElement.style.setProperty('display', 'block', 'important');
             }
             if (totalPagesEl && totalPagesEl.parentElement && totalPagesEl.parentElement.parentElement) {
                 totalPagesEl.parentElement.parentElement.style.setProperty('display', 'block', 'important');
             }
             if (correctAnswersEl && correctAnswersEl.parentElement && correctAnswersEl.parentElement.parentElement) {
                 correctAnswersEl.parentElement.parentElement.style.setProperty('display', 'block', 'important');
             }
             if (scorePercentageEl && scorePercentageEl.parentElement && scorePercentageEl.parentElement.parentElement) {
                 scorePercentageEl.parentElement.parentElement.style.setProperty('display', 'block', 'important');
             }
             
             // Réafficher les boutons de navigation et d'action
             const navigationSection = document.querySelector('.text-center.mt-4');
             if (navigationSection) {
                 navigationSection.style.display = 'block';
             }
             
             // Réafficher la navigation par pages en bas
             const pageNavigation = document.querySelector('.row.mt-4');
             if (pageNavigation) {
                 pageNavigation.style.display = 'block';
             }
             
             // Réafficher la barre de progression en haut
             const progressBar = document.querySelector('.progress-bar-container');
             if (progressBar) {
                 progressBar.style.display = 'block';
             }
             
             // Réafficher le sélecteur de pages en haut
             const pageSelectorTop = document.getElementById('page-selector');
             if (pageSelectorTop) {
                 pageSelectorTop.style.display = 'block';
             }
             
             document.getElementById('results-container').style.display = 'none';
             
             displayPage(0);
             updateProgress();
             updatePageSelector();
             updateScoreButton();
         }
          
          function exportToPDF() {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF();
              
              // Informations du QCM
              const qcmTitle = currentQCM.title;
              const qcmDescription = currentQCM.description;
              const totalScore = calculateScore();
              const totalQuestions = getTotalQuestions();
              const totalPercentage = Math.round((totalScore.correct / totalQuestions) * 100);
              const elapsedTimeString = getElapsedTimeString();
              
              // Calculer le score par page
              let pageScores = [];
              currentQCM.pages.forEach((page, pageIndex) => {
                  let pageCorrect = 0;
                  let pageTotal = 0;
                  let incorrectQuestions = [];
                  let correctQuestions = [];
                  
                  page.questions.forEach((question, questionIndex) => {
                      const userAnswer = userAnswers[question.id] || [];
                      const correctAnswer = question.correctAnswers.map(a => a.toUpperCase());
                      
                      if (userAnswer.length === correctAnswer.length && 
                          userAnswer.every(answer => correctAnswer.includes(answer.toUpperCase()))) {
                          pageCorrect++;
                          // Ajouter les détails de la question correcte
                          correctQuestions.push({
                              questionNumber: questionIndex + 1,
                              questionText: question.text,
                              userAnswer: userAnswer.length > 0 ? userAnswer.join(', ') : 'Aucune réponse',
                              correctAnswer: correctAnswer.join(', '),
                              explanation: question.explanation || 'Aucune explication disponible'
                          });
                      } else {
                          incorrectQuestions.push({
                              questionNumber: questionIndex + 1,
                              questionText: question.text,
                              userAnswer: userAnswer.length > 0 ? userAnswer.join(', ') : 'Aucune réponse',
                              correctAnswer: correctAnswer.join(', '),
                              explanation: question.explanation || 'Aucune explication disponible'
                          });
                      }
                      pageTotal++;
                  });
                  
                  const pagePercentage = pageTotal > 0 ? Math.round((pageCorrect / pageTotal) * 100) : 0;
                  pageScores.push({
                      pageName: page.name,
                      correct: pageCorrect,
                      total: pageTotal,
                      percentage: pagePercentage,
                      correctQuestions: correctQuestions,
                      incorrectQuestions: incorrectQuestions
                  });
              });
              
              // Configuration du PDF
              const pageWidth = doc.internal.pageSize.width;
              const margin = 20;
              const contentWidth = pageWidth - (2 * margin);
              let yPosition = 20;
              
              // Titre principal
              doc.setFontSize(20);
              doc.setFont('helvetica', 'bold');
              doc.text('Rapport de Quiz - MCQED', pageWidth / 2, yPosition, { align: 'center' });
              yPosition += 15;
              
              // Informations du QCM
              doc.setFontSize(14);
              doc.setFont('helvetica', 'bold');
              doc.text(qcmTitle, margin, yPosition);
              yPosition += 10;
              
              doc.setFontSize(12);
              doc.setFont('helvetica', 'normal');
              doc.text(qcmDescription, margin, yPosition);
              yPosition += 15;
              
              // Score total
              doc.setFontSize(16);
              doc.setFont('helvetica', 'bold');
              const scoreText = `Score Total: ${totalPercentage}% (${totalScore.correct}/${totalQuestions} bonnes réponses)`;
              doc.text(scoreText, pageWidth / 2, yPosition, { align: 'center' });
              yPosition += 8;
              
              // Temps total
              doc.setFontSize(12);
              doc.setFont('helvetica', 'normal');
              const timeText = `Temps total: ${elapsedTimeString}`;
              doc.text(timeText, pageWidth / 2, yPosition, { align: 'center' });
              yPosition += 10;
              
              // Message de réussite/échec
              doc.setFontSize(12);
              doc.setFont('helvetica', 'normal');
              const resultMessage = totalPercentage >= 70 ? 
                  'Félicitations ! Vous avez réussi le quiz.' : 
                  'Vous devez obtenir au moins 70% pour réussir.';
              doc.text(resultMessage, pageWidth / 2, yPosition, { align: 'center' });
              yPosition += 20;
              
              // Détail par page
              doc.setFontSize(14);
              doc.setFont('helvetica', 'bold');
              doc.text('Détail par page :', margin, yPosition);
              yPosition += 15;
              
              pageScores.forEach((pageScore, index) => {
                  // Vérifier si on a besoin d'une nouvelle page
                  if (yPosition > 250) {
                      doc.addPage();
                      yPosition = 20;
                  }
                  
                  // En-tête de la page
                  doc.setFontSize(12);
                  doc.setFont('helvetica', 'bold');
                  const pageHeader = `Page ${index + 1}: ${pageScore.pageName}`;
                  doc.text(pageHeader, margin, yPosition);
                  yPosition += 8;
                  
                  // Statistiques de la page
                  doc.setFontSize(10);
                  doc.setFont('helvetica', 'normal');
                  const pageStats = `Score: ${pageScore.percentage}% | Bonnes réponses: ${pageScore.correct}/${pageScore.total}`;
                  doc.text(pageStats, margin, yPosition);
                  yPosition += 10;
                  
                  // Questions correctes
                  if (pageScore.correctQuestions.length > 0) {
                      doc.setFontSize(11);
                      doc.setFont('helvetica', 'bold');
                      doc.setTextColor(40, 167, 69); // Vert pour les questions correctes
                      doc.text(`✓ Questions correctes (${pageScore.correctQuestions.length}) :`, margin, yPosition);
                      yPosition += 8;
                      
                      pageScore.correctQuestions.forEach((correct, qIndex) => {
                          // Vérifier si on a besoin d'une nouvelle page
                          if (yPosition > 250) {
                              doc.addPage();
                              yPosition = 20;
                          }
                          
                          doc.setFontSize(9);
                          doc.setFont('helvetica', 'bold');
                          doc.text(`Question ${correct.questionNumber}:`, margin, yPosition);
                          yPosition += 5;
                          
                          // Texte de la question (tronqué si trop long)
                          doc.setFont('helvetica', 'normal');
                          const questionText = correct.questionText.length > 80 ? 
                              correct.questionText.substring(0, 80) + '...' : 
                              correct.questionText;
                          doc.text(questionText, margin + 5, yPosition);
                          yPosition += 5;
                          
                          // Réponses
                          doc.text(`Votre réponse: ${correct.userAnswer}`, margin + 5, yPosition);
                          yPosition += 4;
                          doc.text(`Réponse correcte: ${correct.correctAnswer}`, margin + 5, yPosition);
                          yPosition += 4;
                          
                          // Explication si disponible
                          if (correct.explanation !== 'Aucune explication disponible') {
                              const explanation = correct.explanation.length > 60 ? 
                                  correct.explanation.substring(0, 60) + '...' : 
                                  correct.explanation;
                              doc.text(`Explication: ${explanation}`, margin + 5, yPosition);
                              yPosition += 4;
                          }
                          
                          yPosition += 3; // Espacement entre questions
                      });
                      
                      // Remettre la couleur par défaut
                      doc.setTextColor(0, 0, 0);
                      yPosition += 5; // Espacement supplémentaire
                  }
                  
                  // Questions incorrectes
                  if (pageScore.incorrectQuestions.length > 0) {
                      doc.setFontSize(11);
                      doc.setFont('helvetica', 'bold');
                      doc.setTextColor(220, 53, 69); // Rouge pour les questions incorrectes
                      doc.text(`✗ Questions incorrectes (${pageScore.incorrectQuestions.length}) :`, margin, yPosition);
                      yPosition += 8;
                      
                      pageScore.incorrectQuestions.forEach((incorrect, qIndex) => {
                          // Vérifier si on a besoin d'une nouvelle page
                          if (yPosition > 250) {
                              doc.addPage();
                              yPosition = 20;
                          }
                          
                          doc.setFontSize(9);
                          doc.setFont('helvetica', 'bold');
                          doc.text(`Question ${incorrect.questionNumber}:`, margin, yPosition);
                          yPosition += 5;
                          
                          // Texte de la question (tronqué si trop long)
                          doc.setFont('helvetica', 'normal');
                          const questionText = incorrect.questionText.length > 80 ? 
                              incorrect.questionText.substring(0, 80) + '...' : 
                              incorrect.questionText;
                          doc.text(questionText, margin + 5, yPosition);
                          yPosition += 5;
                          
                          // Réponses
                          doc.text(`Votre réponse: ${incorrect.userAnswer}`, margin + 5, yPosition);
                          yPosition += 4;
                          doc.text(`Réponse correcte: ${incorrect.correctAnswer}`, margin + 5, yPosition);
                          yPosition += 4;
                          
                          // Explication si disponible
                          if (incorrect.explanation !== 'Aucune explication disponible') {
                              const explanation = incorrect.explanation.length > 60 ? 
                                  incorrect.explanation.substring(0, 60) + '...' : 
                                  incorrect.explanation;
                              doc.text(`Explication: ${explanation}`, margin + 5, yPosition);
                              yPosition += 4;
                          }
                          
                          yPosition += 3; // Espacement entre questions
                      });
                      
                      // Remettre la couleur par défaut
                      doc.setTextColor(0, 0, 0);
                  }
                  
                  // Si aucune question n'a été répondue
                  if (pageScore.correctQuestions.length === 0 && pageScore.incorrectQuestions.length === 0) {
                      doc.setFontSize(10);
                      doc.setFont('helvetica', 'normal');
                      doc.setTextColor(255, 193, 7); // Jaune pour l'avertissement
                      doc.text('⚠ Aucune question répondue', margin, yPosition);
                      doc.setTextColor(0, 0, 0);
                      yPosition += 8;
                  }
                  
                  yPosition += 5; // Espacement entre pages
              });
              
              // Pied de page
              const currentDate = new Date().toLocaleDateString('fr-FR');
              const currentTime = new Date().toLocaleTimeString('fr-FR');
              doc.setFontSize(8);
              doc.setFont('helvetica', 'normal');
              doc.text(`Généré le ${currentDate} à ${currentTime} par MCQED`, pageWidth / 2, 280, { align: 'center' });
              
              // Sauvegarder le PDF
              const fileName = `quiz_${qcmTitle.replace(/[^a-zA-Z0-9]/g, '_')}_${currentDate.replace(/\//g, '-')}.pdf`;
              doc.save(fileName);
              
              // Notification de succès
              showNotification('PDF exporté avec succès !', 'success');
          }
        
        // Variables pour le chronomètre
        let timerInterval;
        let startTime;
        let elapsedTime = 0;
        let isTimerRunning = false;
        let isTimerPaused = false;
        
        // Fonction pour démarrer le chronomètre
        function startTimer() {
            if (!isTimerRunning) {
                startTime = Date.now() - elapsedTime;
                isTimerRunning = true;
                isTimerPaused = false;
                timerInterval = setInterval(updateTimer, 1000);
                updateTimerButton();
            }
        }
        
        // Fonction pour mettre en pause/reprendre le chronomètre
        function toggleTimerPause() {
            if (isTimerRunning) {
                if (isTimerPaused) {
                    // Reprendre
                    startTime = Date.now() - elapsedTime;
                    isTimerPaused = false;
                    timerInterval = setInterval(updateTimer, 1000);
                } else {
                    // Mettre en pause
                    clearInterval(timerInterval);
                    elapsedTime = Date.now() - startTime;
                    isTimerPaused = true;
                }
                updateTimerButton();
            }
        }
        
        // Fonction pour arrêter le chronomètre
        function stopTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            isTimerPaused = false;
            elapsedTime = 0;
            updateTimerDisplay();
            updateTimerButton();
        }
        
        // Fonction pour mettre à jour l'affichage du chronomètre
        function updateTimer() {
            if (isTimerRunning && !isTimerPaused) {
                elapsedTime = Date.now() - startTime;
                updateTimerDisplay();
            }
        }
        
        // Fonction pour mettre à jour l'affichage
        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timer-display');
            if (timerDisplay) {
                const hours = Math.floor(elapsedTime / 3600000);
                const minutes = Math.floor((elapsedTime % 3600000) / 60000);
                const seconds = Math.floor((elapsedTime % 60000) / 1000);
                
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                timerDisplay.textContent = timeString;
            }
        }
        
        // Fonction pour mettre à jour le bouton pause/play
        function updateTimerButton() {
            const pauseButton = document.getElementById('timer-pause-btn');
            if (pauseButton) {
                if (isTimerPaused) {
                    pauseButton.innerHTML = '<i class="fas fa-play"></i>';
                    pauseButton.title = 'Reprendre le chronomètre';
                } else {
                    pauseButton.innerHTML = '<i class="fas fa-pause"></i>';
                    pauseButton.title = 'Mettre en pause';
                }
            }
        }
        
        // Fonction pour obtenir le temps écoulé en format lisible
        function getElapsedTimeString() {
            const hours = Math.floor(elapsedTime / 3600000);
            const minutes = Math.floor((elapsedTime % 3600000) / 60000);
            const seconds = Math.floor((elapsedTime % 60000) / 1000);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }
        
        // Démarrer le chronomètre au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Démarrer le chronomètre automatiquement
            setTimeout(startTimer, 1000);
            
            // Initialiser les boutons de thème
            initializeThemeButtons();
        });
        
        // Fonction pour initialiser les boutons de thème
        function initializeThemeButtons() {
            const darkModeBtn = document.getElementById('dark-mode-btn');
            const colorblindBtn = document.getElementById('colorblind-btn');
            
            // Récupérer les préférences sauvegardées
            const savedTheme = localStorage.getItem('mcqed_theme') || 'light';
            const savedColorblind = localStorage.getItem('mcqed_colorblind') || 'disabled';
            
            // Appliquer les thèmes
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.documentElement.setAttribute('data-colorblind', savedColorblind);
            
            // Mettre à jour les boutons
            if (darkModeBtn) {
                const icon = darkModeBtn.querySelector('i');
                if (savedTheme === 'dark') {
                    icon.className = 'fas fa-sun';
                    darkModeBtn.title = 'Mode clair';
                    darkModeBtn.classList.add('active');
                } else {
                    icon.className = 'fas fa-moon';
                    darkModeBtn.title = 'Mode sombre';
                    darkModeBtn.classList.remove('active');
                }
            }
            
            if (colorblindBtn) {
                const icon = colorblindBtn.querySelector('i');
                if (savedColorblind === 'enabled') {
                    icon.className = 'fas fa-eye-slash';
                    colorblindBtn.title = 'Mode normal';
                    colorblindBtn.classList.add('active');
                } else {
                    icon.className = 'fas fa-eye';
                    colorblindBtn.title = 'Mode daltonien';
                    colorblindBtn.classList.remove('active');
                }
            }
        }
        
        // Fonction pour basculer le mode sombre
        function toggleDarkMode() {
            const darkModeBtn = document.getElementById('dark-mode-btn');
            const icon = darkModeBtn.querySelector('i');
            
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            // Appliquer le nouveau thème
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('mcqed_theme', newTheme);
            
            // Mettre à jour le bouton
            if (newTheme === 'dark') {
                icon.className = 'fas fa-sun';
                darkModeBtn.title = 'Mode clair';
                darkModeBtn.classList.add('active');
            } else {
                icon.className = 'fas fa-moon';
                darkModeBtn.title = 'Mode sombre';
                darkModeBtn.classList.remove('active');
            }
        }
        
        // Fonction pour basculer le mode daltonien
        function toggleColorblindMode() {
            const colorblindBtn = document.getElementById('colorblind-btn');
            const icon = colorblindBtn.querySelector('i');
            
            const currentMode = document.documentElement.getAttribute('data-colorblind');
            const newMode = currentMode === 'enabled' ? 'disabled' : 'enabled';
            
            // Appliquer le nouveau mode
            document.documentElement.setAttribute('data-colorblind', newMode);
            localStorage.setItem('mcqed_colorblind', newMode);
            
            // Mettre à jour le bouton
            if (newMode === 'enabled') {
                icon.className = 'fas fa-eye-slash';
                colorblindBtn.title = 'Mode normal';
                colorblindBtn.classList.add('active');
            } else {
                icon.className = 'fas fa-eye';
                colorblindBtn.title = 'Mode daltonien';
                colorblindBtn.classList.remove('active');
            }
        }
    </script>
    <script src="dark-mode.js"></script>
    
    <!-- Carte des boutons d'action flottante -->
    <div id="action-container" class="action-container">
        <div class="action-header">
            <i class="fas fa-tools"></i>
            <span>Actions</span>
        </div>
        <div class="action-buttons-vertical">
            <button class="action-btn-vertical shuffle-btn" onclick="shuffleCurrentPageQuestions()" title="Mélanger l'ordre des questions">
                <i class="fas fa-random"></i>
            </button>
            <button class="action-btn-vertical score-btn" id="score-btn-top" onclick="togglePageScore()" title="Voir le score de cette page">
                <i class="fas fa-chart-pie"></i>
            </button>
            <button class="action-btn-vertical reset-btn" onclick="resetPageAnswers()" title="Réinitialiser les réponses de cette page">
                <i class="fas fa-undo"></i>
            </button>
        </div>
    </div>

    <!-- Carte des thèmes flottante -->
    <div id="theme-container" class="theme-container">
        <div class="theme-header">
            <i class="fas fa-palette"></i>
            <span>Thème</span>
        </div>
        <div class="theme-buttons-vertical">
            <button id="dark-mode-btn" class="theme-btn-vertical" onclick="toggleDarkMode()" title="Mode sombre">
                <i class="fas fa-moon"></i>
            </button>
            <button id="colorblind-btn" class="theme-btn-vertical" onclick="toggleColorblindMode()" title="Mode daltonien">
                <i class="fas fa-eye"></i>
            </button>
        </div>
    </div>

    <!-- Chronomètre flottant -->
    <div id="timer-container" class="timer-container">
        <div class="timer-header">
            <i class="fas fa-clock"></i>
            <span>Chronomètre</span>
            <button id="timer-pause-btn" class="timer-pause-btn" onclick="toggleTimerPause()" title="Mettre en pause">
                <i class="fas fa-pause"></i>
            </button>
        </div>
        <div id="timer-display" class="timer-display">00:00:00</div>
    </div>
    
    <!-- Boutons flottants -->
    <div class="floating-buttons">
        <a href="index.html" class="floating-btn home">
            <i class="fas fa-home"></i>
            Accueil
        </a>
        <a href="#" onclick="logout()" class="floating-btn logout">
            <i class="fas fa-sign-out-alt"></i>
            Se déconnecter
        </a>
    </div>
</body>
</html> 