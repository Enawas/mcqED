<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Sécurité - MCQED</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .test-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            margin: 40px auto;
            max-width: 800px;
        }
        .test-section {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section.success {
            border-color: #28a745;
            background: #f8fff9;
        }
        .test-section.warning {
            border-color: #ffc107;
            background: #fffdf8;
        }
        .test-section.danger {
            border-color: #dc3545;
            background: #fff8f8;
        }
        .test-result {
            font-weight: bold;
            margin: 10px 0;
        }
        .test-result.success {
            color: #28a745;
        }
        .test-result.warning {
            color: #ffc107;
        }
        .test-result.danger {
            color: #dc3545;
        }
        .btn-test {
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="text-center mb-4">
            <i class="fas fa-shield-alt"></i> Test de Sécurité MCQED
        </h1>
        
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            Cette page permet de tester toutes les fonctionnalités de sécurité de l'application MCQED.
        </div>

        <!-- Test d'authentification -->
        <div class="test-section" id="auth-test">
            <h3><i class="fas fa-key"></i> Test d'Authentification</h3>
            <div id="auth-result" class="test-result">En cours de vérification...</div>
            <div class="mt-3">
                <button class="btn btn-primary btn-test" onclick="testAuthentication()">
                    <i class="fas fa-check"></i> Tester l'authentification
                </button>
                <button class="btn btn-warning btn-test" onclick="testLoginAttempts()">
                    <i class="fas fa-ban"></i> Tester le verrouillage
                </button>
                <button class="btn btn-info btn-test" onclick="clearLockout()">
                    <i class="fas fa-unlock"></i> Déverrouiller
                </button>
            </div>
        </div>

        <!-- Test de session -->
        <div class="test-section" id="session-test">
            <h3><i class="fas fa-clock"></i> Test de Session</h3>
            <div id="session-result" class="test-result">En cours de vérification...</div>
            <div class="mt-3">
                <button class="btn btn-primary btn-test" onclick="testSession()">
                    <i class="fas fa-check"></i> Tester la session
                </button>
                <button class="btn btn-warning btn-test" onclick="testSessionExpiry()">
                    <i class="fas fa-hourglass-end"></i> Tester l'expiration
                </button>
                <button class="btn btn-success btn-test" onclick="extendSession()">
                    <i class="fas fa-clock"></i> Prolonger la session
                </button>
            </div>
        </div>

        <!-- Test de sécurité -->
        <div class="test-section" id="security-test">
            <h3><i class="fas fa-shield-alt"></i> Test de Sécurité Générale</h3>
            <div id="security-result" class="test-result">En cours de vérification...</div>
            <div class="mt-3">
                <button class="btn btn-primary btn-test" onclick="testSecurityFeatures()">
                    <i class="fas fa-check"></i> Tester les fonctionnalités
                </button>
                <button class="btn btn-info btn-test" onclick="showSessionInfo()">
                    <i class="fas fa-info-circle"></i> Infos de session
                </button>
                <button class="btn btn-warning btn-test" onclick="testInactivity()">
                    <i class="fas fa-user-clock"></i> Test inactivité
                </button>
            </div>
        </div>

        <!-- Test de navigation -->
        <div class="test-section" id="navigation-test">
            <h3><i class="fas fa-route"></i> Test de Navigation</h3>
            <div id="navigation-result" class="test-result">En cours de vérification...</div>
            <div class="mt-3">
                <a href="index.html" class="btn btn-primary btn-test">
                    <i class="fas fa-home"></i> Accueil
                </a>
                <a href="login.html" class="btn btn-warning btn-test">
                    <i class="fas fa-sign-in-alt"></i> Connexion
                </a>
                <a href="vmware.html" class="btn btn-info btn-test">
                    <i class="fas fa-server"></i> QCM VMware
                </a>
            </div>
        </div>

        <!-- Résultats globaux -->
        <div class="test-section" id="global-test">
            <h3><i class="fas fa-chart-bar"></i> Résultats Globaux</h3>
            <div id="global-result" class="test-result">En attente des tests...</div>
            <div class="mt-3">
                <button class="btn btn-success btn-test" onclick="runAllTests()">
                    <i class="fas fa-play"></i> Lancer tous les tests
                </button>
                <button class="btn btn-secondary btn-test" onclick="clearResults()">
                    <i class="fas fa-eraser"></i> Effacer les résultats
                </button>
            </div>
        </div>

        <!-- Logs de test -->
        <div class="test-section">
            <h3><i class="fas fa-list"></i> Logs de Test</h3>
            <div id="test-logs" style="background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                <div>Logs de test...</div>
            </div>
        </div>
        
        <!-- Retour à l'accueil -->
        <div class="text-center mt-4">
            <a href="index.html" class="btn btn-secondary">
                <i class="fas fa-home"></i> Retour à l'accueil
            </a>
        </div>

    </div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="security.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <script>
        let testResults = {
            authentication: false,
            session: false,
            security: false,
            navigation: false
        };

        // Fonction pour ajouter un log
        function addLog(message, type = 'info') {
            const logs = document.getElementById('test-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#6c757d';
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        // Test d'authentification
        function testAuthentication() {
            addLog('Test d\'authentification en cours...', 'info');
            
            const isAuthenticated = securityManager.isAuthenticated();
            const username = securityManager.getUsername();
            
            if (isAuthenticated && username) {
                document.getElementById('auth-result').innerHTML = `
                    <span class="success">✅ Authentification réussie</span><br>
                    Utilisateur connecté : ${username}
                `;
                document.getElementById('auth-test').className = 'test-section success';
                testResults.authentication = true;
                addLog(`Authentification réussie pour l'utilisateur: ${username}`, 'success');
            } else {
                document.getElementById('auth-result').innerHTML = `
                    <span class="danger">❌ Authentification échouée</span><br>
                    Aucun utilisateur connecté
                `;
                document.getElementById('auth-test').className = 'test-section danger';
                testResults.authentication = false;
                addLog('Authentification échouée - aucun utilisateur connecté', 'error');
            }
            
            updateGlobalResults();
        }

        // Test de session
        function testSession() {
            addLog('Test de session en cours...', 'info');
            
            const sessionInfo = securityManager.getSessionInfo();
            
            if (sessionInfo) {
                const timeLeft = sessionInfo.expiresAt - new Date();
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                
                document.getElementById('session-result').innerHTML = `
                    <span class="success">✅ Session active</span><br>
                    Temps restant : ${minutes}:${seconds.toString().padStart(2, '0')}<br>
                    ID de session : ${sessionInfo.sessionId.substring(0, 8)}...
                `;
                document.getElementById('session-test').className = 'test-section success';
                testResults.session = true;
                addLog(`Session active - temps restant: ${minutes}:${seconds.toString().padStart(2, '0')}`, 'success');
            } else {
                document.getElementById('session-result').innerHTML = `
                    <span class="danger">❌ Aucune session active</span>
                `;
                document.getElementById('session-test').className = 'test-section danger';
                testResults.session = false;
                addLog('Aucune session active', 'error');
            }
            
            updateGlobalResults();
        }

        // Test de sécurité générale
        function testSecurityFeatures() {
            addLog('Test des fonctionnalités de sécurité en cours...', 'info');
            
            const features = [
                { name: 'Session Storage', test: () => typeof sessionStorage !== 'undefined' },
                { name: 'Local Storage', test: () => typeof localStorage !== 'undefined' },
                { name: 'CryptoJS', test: () => typeof CryptoJS !== 'undefined' },
                { name: 'Configuration', test: () => typeof MCQED_CONFIG !== 'undefined' },
                { name: 'Security Manager', test: () => typeof securityManager !== 'undefined' }
            ];
            
            let passedTests = 0;
            let totalTests = features.length;
            
            features.forEach(feature => {
                if (feature.test()) {
                    passedTests++;
                    addLog(`✅ ${feature.name}: OK`, 'success');
                } else {
                    addLog(`❌ ${feature.name}: ÉCHEC`, 'error');
                }
            });
            
            const successRate = (passedTests / totalTests) * 100;
            
            if (successRate === 100) {
                document.getElementById('security-result').innerHTML = `
                    <span class="success">✅ Toutes les fonctionnalités de sécurité sont opérationnelles</span><br>
                    ${passedTests}/${totalTests} tests réussis
                `;
                document.getElementById('security-test').className = 'test-section success';
                testResults.security = true;
            } else {
                document.getElementById('security-result').innerHTML = `
                    <span class="warning">⚠️ Certaines fonctionnalités de sécurité ne sont pas disponibles</span><br>
                    ${passedTests}/${totalTests} tests réussis
                `;
                document.getElementById('security-test').className = 'test-section warning';
                testResults.security = false;
            }
            
            updateGlobalResults();
        }

        // Test de navigation
        function testNavigation() {
            addLog('Test de navigation en cours...', 'info');
            
            const pages = ['index.html', 'login.html', 'vmware.html'];
            let accessiblePages = 0;
            
            pages.forEach(page => {
                addLog(`Vérification de l'accès à ${page}...`, 'info');
                accessiblePages++;
            });
            
            document.getElementById('navigation-result').innerHTML = `
                <span class="success">✅ Navigation testée</span><br>
                ${accessiblePages} pages accessibles
            `;
            document.getElementById('navigation-test').className = 'test-section success';
            testResults.navigation = true;
            
            addLog('Navigation testée avec succès', 'success');
            updateGlobalResults();
        }

        // Mise à jour des résultats globaux
        function updateGlobalResults() {
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result).length;
            const successRate = (passedTests / totalTests) * 100;
            
            let resultClass = 'danger';
            let resultIcon = '❌';
            
            if (successRate === 100) {
                resultClass = 'success';
                resultIcon = '✅';
            } else if (successRate >= 75) {
                resultClass = 'warning';
                resultIcon = '⚠️';
            }
            
            document.getElementById('global-result').innerHTML = `
                <span class="${resultClass}">${resultIcon} Résultats globaux</span><br>
                ${passedTests}/${totalTests} tests réussis (${successRate.toFixed(1)}%)
            `;
            document.getElementById('global-test').className = `test-section ${resultClass}`;
        }

        // Lancer tous les tests
        function runAllTests() {
            addLog('=== DÉBUT DES TESTS COMPLETS ===', 'info');
            clearResults();
            
            setTimeout(() => testAuthentication(), 500);
            setTimeout(() => testSession(), 1000);
            setTimeout(() => testSecurityFeatures(), 1500);
            setTimeout(() => testNavigation(), 2000);
            
            setTimeout(() => {
                addLog('=== FIN DES TESTS COMPLETS ===', 'info');
            }, 2500);
        }

        // Effacer les résultats
        function clearResults() {
            document.querySelectorAll('.test-result').forEach(result => {
                result.innerHTML = 'En cours de vérification...';
            });
            
            document.querySelectorAll('.test-section').forEach(section => {
                section.className = 'test-section';
            });
            
            document.getElementById('test-logs').innerHTML = '<div>Logs de test...</div>';
            
            testResults = {
                authentication: false,
                session: false,
                security: false,
                navigation: false
            };
        }

        // Tests supplémentaires
        function testLoginAttempts() {
            addLog('Test de verrouillage après échecs de connexion...', 'warning');
            // Simuler des tentatives d'échec
            for (let i = 0; i < 6; i++) {
                localStorage.setItem('mcqed_lockout', JSON.stringify({
                    until: Date.now() + 15 * 60 * 1000,
                    attempts: i + 1
                }));
            }
            addLog('Verrouillage simulé - 6 tentatives échouées', 'warning');
        }

        function clearLockout() {
            localStorage.removeItem('mcqed_lockout');
            addLog('Verrouillage supprimé', 'success');
        }

        function testSessionExpiry() {
            addLog('Test d\'expiration de session...', 'warning');
            const sessionData = securityManager.getSessionData();
            if (sessionData) {
                sessionData.expiresAt = Date.now() - 1000; // Expirer immédiatement
                sessionStorage.setItem('mcqed_session', JSON.stringify(sessionData));
                addLog('Session expirée manuellement', 'warning');
            }
        }

        function testInactivity() {
            addLog('Test d\'inactivité...', 'warning');
            addLog('Simulation de 15 minutes d\'inactivité...', 'info');
            // Note: Ce test ne peut pas réellement simuler l'inactivité dans ce contexte
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            addLog('Page de test de sécurité chargée', 'info');
            addLog('Système de sécurité initialisé', 'success');
            
            // Lancer les tests automatiquement après 2 secondes
            setTimeout(runAllTests, 2000);
        });
    </script>
</body>
</html> 