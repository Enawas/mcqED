<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur de QCM - MCQED</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="dark-mode.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand {
            font-weight: 700;
            color: #667eea !important;
        }
        .quiz-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin: 20px auto;
            max-width: 800px;
        }
        .question-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        .option-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .option-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .option-item.selected {
            border-color: #28a745;
            background: #f8fff9;
        }
        .option-item.correct {
            border-color: #28a745;
            background: #d4edda;
        }
        .option-item.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .progress-bar {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        .btn-qcm {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: bold;
            margin: 10px 5px;
        }
        .btn-qcm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
            text-decoration: none;
        }
        .explanation-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-graduation-cap"></i> mcqED
            </a>
            <div class="navbar-nav ml-auto">
                <div class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="fas fa-home"></i> Accueil
                    </a>
                </div>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown">
                        <i class="fas fa-user-circle"></i> <span id="username-display">Utilisateur</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right">
                        <a class="dropdown-item" href="password-generator.html">
                            <i class="fas fa-key"></i> Générateur de mot de passe
                        </a>
                        <a class="dropdown-item" href="diagnostic-login.html">
                            <i class="fas fa-stethoscope"></i> Diagnostic système
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Se déconnecter
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="quiz-container">
        <div class="text-center mb-4">
            <h1 id="qcm-title"><i class="fas fa-play"></i> Chargement...</h1>
            <p class="text-muted" id="qcm-description">Chargement du QCM...</p>
        </div>

        <!-- Barre de progression -->
        <div class="progress mb-4" style="height: 10px;">
            <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>

        <!-- Informations du quiz -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="text-center">
                    <h5 id="current-question">0</h5>
                    <small class="text-muted">Question actuelle</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h5 id="total-questions">0</h5>
                    <small class="text-muted">Total questions</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h5 id="correct-answers">0</h5>
                    <small class="text-muted">Réponses correctes</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h5 id="score-percentage">0%</h5>
                    <small class="text-muted">Score</small>
                </div>
            </div>
        </div>

        <!-- Zone de question -->
        <div id="question-container">
            <div class="text-center">
                <p>Chargement du QCM...</p>
            </div>
        </div>

        <!-- Boutons de navigation -->
        <div class="text-center mt-4">
            <button class="btn btn-secondary" id="prev-btn" onclick="previousQuestion()" disabled>
                <i class="fas fa-chevron-left"></i> Précédent
            </button>
            <button class="btn btn-qcm" id="next-btn" onclick="nextQuestion()">
                Suivant <i class="fas fa-chevron-right"></i>
            </button>
            <button class="btn btn-success" id="finish-btn" onclick="finishQuiz()" style="display: none;">
                <i class="fas fa-check"></i> Terminer
            </button>
            <button class="btn btn-info" id="show-answer-btn" onclick="showAnswer()" style="display: none;">
                <i class="fas fa-lightbulb"></i> Voir la réponse
            </button>
        </div>

        <!-- Résultats -->
        <div id="results-container" style="display: none;">
            <div class="text-center">
                <h3>Résultats du Quiz</h3>
                <div class="alert alert-info">
                    <h4 id="final-score">Score: 0%</h4>
                    <p id="final-message">Message de résultat</p>
                </div>
                <button class="btn btn-qcm" onclick="restartQuiz()">
                    <i class="fas fa-redo"></i> Recommencer
                </button>
                <a href="index.html" class="btn btn-secondary">
                    <i class="fas fa-home"></i> Retour à l'accueil
                </a>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let currentQCM = null;
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let quizCompleted = false;
        let showAnswers = false;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkSession()) {
                window.location.href = 'login.html';
                return;
            }
            
            updateUserDisplay();
            loadQCMFromURL();
        });

        function checkSession() {
            const sessionData = sessionStorage.getItem('mcqed_session');
            if (!sessionData) {
                return false;
            }

            try {
                const session = JSON.parse(sessionData);
                const now = Date.now();
                
                if (session.expiresAt <= now) {
                    sessionStorage.removeItem('mcqed_session');
                    return false;
                }
                
                return true;
            } catch (e) {
                sessionStorage.removeItem('mcqed_session');
                return false;
            }
        }

        function updateUserDisplay() {
            const sessionData = JSON.parse(sessionStorage.getItem('mcqed_session'));
            document.getElementById('username-display').textContent = sessionData.userId;
        }

        function logout() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                sessionStorage.removeItem('mcqed_session');
                window.location.href = 'login.html';
            }
        }

        function loadQCMFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const qcmId = urlParams.get('qcm');
            
            if (!qcmId) {
                alert('Aucun QCM spécifié');
                window.location.href = 'index.html';
                return;
            }

            const qcms = JSON.parse(localStorage.getItem('mcqed_qcms') || '[]');
            currentQCM = qcms.find(qcm => qcm.id === qcmId);
            
            if (!currentQCM) {
                alert('QCM non trouvé');
                window.location.href = 'index.html';
                return;
            }

            // Vérification des questions - gérer les deux structures (avec et sans pages)
            let hasQuestions = false;
            if (currentQCM.pages && currentQCM.pages.length > 0) {
                hasQuestions = currentQCM.pages.some(page => page.questions && page.questions.length > 0);
            } else if (currentQCM.questions) {
                hasQuestions = currentQCM.questions.length > 0;
            }
            
            if (!hasQuestions) {
                alert('Ce QCM ne contient aucune question');
                window.location.href = 'index.html';
                return;
            }

            // Récupérer toutes les questions de toutes les pages
            let allQuestions = [];
            if (currentQCM.pages && currentQCM.pages.length > 0) {
                // Structure avec pages
                allQuestions = currentQCM.pages.flatMap(page => page.questions);
            } else if (currentQCM.questions) {
                // Structure sans pages (ancienne version)
                allQuestions = currentQCM.questions;
            }
            
            if (allQuestions.length === 0) {
                alert('Ce QCM ne contient aucune question');
                window.location.href = 'index.html';
                return;
            }

            // Mélanger les questions
            currentQCM.questions = shuffleArray(allQuestions);

            // Afficher les informations du QCM
            document.getElementById('qcm-title').innerHTML = `<i class="fas fa-play"></i> ${currentQCM.title}`;
            document.getElementById('qcm-description').textContent = currentQCM.description;
            document.getElementById('total-questions').textContent = currentQCM.questions.length;

            // Afficher la première question
            displayQuestion(0);
            updateProgress();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function displayQuestion(index) {
            if (!currentQCM || !currentQCM.questions[index]) {
                return;
            }

            const question = currentQCM.questions[index];
            const container = document.getElementById('question-container');
            
            document.getElementById('current-question').textContent = index + 1;
            
            let optionsHTML = '';
            question.options.forEach((option, optionIndex) => {
                const optionLetter = option.id.toUpperCase();
                const isSelected = userAnswers[question.id] && userAnswers[question.id].includes(optionLetter);
                let selectedClass = isSelected ? 'selected' : '';
                
                // Ajouter les classes pour les réponses correctes/incorrectes si on affiche les réponses
                if (showAnswers) {
                    if (question.correctAnswers.includes(option.id)) {
                        selectedClass += ' correct';
                    } else if (isSelected) {
                        selectedClass += ' incorrect';
                    }
                }
                
                optionsHTML += `
                    <div class="option-item ${selectedClass}" onclick="selectOption('${optionLetter}', '${question.id}')">
                        <strong>${optionLetter}.</strong> ${option.text}
                    </div>
                `;
            });
            
            let explanationHTML = '';
            if (showAnswers && question.explanation) {
                explanationHTML = `
                    <div class="explanation-box">
                        <strong><i class="fas fa-lightbulb"></i> Explication :</strong><br>
                        ${question.explanation}
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="question-card">
                    <h5 class="mb-3">Question ${index + 1}</h5>
                    <p class="mb-4">${question.text}</p>
                    <div class="options-container">
                        ${optionsHTML}
                    </div>
                    ${question.type === 'multiple' ? '<small class="text-muted">Sélectionnez toutes les réponses correctes</small>' : ''}
                    ${explanationHTML}
                </div>
            `;
            
            updateNavigationButtons();
            updateScore();
        }

        function selectOption(optionLetter, questionId) {
            if (showAnswers) return; // Empêcher la sélection si on affiche les réponses
            
            const question = currentQCM.questions.find(q => q.id === questionId);
            
            if (!userAnswers[questionId]) {
                userAnswers[questionId] = [];
            }
            
            if (question.type === 'single') {
                userAnswers[questionId] = [optionLetter];
            } else {
                const index = userAnswers[questionId].indexOf(optionLetter);
                if (index > -1) {
                    userAnswers[questionId].splice(index, 1);
                } else {
                    userAnswers[questionId].push(optionLetter);
                }
            }
            
            displayQuestion(currentQuestionIndex);
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion(currentQuestionIndex);
                updateProgress();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQCM.questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
                updateProgress();
            } else {
                finishQuiz();
            }
        }

        function updateNavigationButtons() {
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === currentQCM.questions.length - 1) {
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('finish-btn').style.display = 'inline-block';
            } else {
                document.getElementById('next-btn').style.display = 'inline-block';
                document.getElementById('finish-btn').style.display = 'none';
            }
            
            // Afficher le bouton "Voir la réponse" si on a répondu
            const currentQuestion = currentQCM.questions[currentQuestionIndex];
            const hasAnswered = userAnswers[currentQuestion.id] && userAnswers[currentQuestion.id].length > 0;
            document.getElementById('show-answer-btn').style.display = hasAnswered ? 'inline-block' : 'none';
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / currentQCM.questions.length) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        function showAnswer() {
            showAnswers = true;
            displayQuestion(currentQuestionIndex);
        }

        function finishQuiz() {
            const score = calculateScore();
            const percentage = Math.round((score.correct / currentQCM.questions.length) * 100);
            
            document.getElementById('final-score').textContent = `Score: ${percentage}%`;
            document.getElementById('final-message').textContent = 
                percentage >= 70 ? 
                'Félicitations ! Vous avez réussi le quiz.' : 
                'Vous devez obtenir au moins 70% pour réussir.';
            
            document.getElementById('question-container').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';
            
            quizCompleted = true;
        }

        function calculateScore() {
            let correct = 0;
            let total = 0;
            
            currentQCM.questions.forEach(question => {
                const userAnswer = userAnswers[question.id] || [];
                const correctAnswer = question.correctAnswers.map(a => a.toUpperCase());
                
                if (userAnswer.length === correctAnswer.length && 
                    userAnswer.every(answer => correctAnswer.includes(answer))) {
                    correct++;
                }
                total++;
            });
            
            return { correct, total };
        }

        function updateScore() {
            const score = calculateScore();
            document.getElementById('correct-answers').textContent = score.correct;
            document.getElementById('score-percentage').textContent = Math.round((score.correct / currentQCM.questions.length) * 100) + '%';
        }

        function restartQuiz() {
            currentQuestionIndex = 0;
            userAnswers = {};
            quizCompleted = false;
            showAnswers = false;
            
            // Récupérer et mélanger à nouveau les questions
            let allQuestions = [];
            if (currentQCM.pages && currentQCM.pages.length > 0) {
                allQuestions = currentQCM.pages.flatMap(page => page.questions);
            } else if (currentQCM.questions) {
                allQuestions = currentQCM.questions;
            }
            
            currentQCM.questions = shuffleArray(allQuestions);
            
            document.getElementById('question-container').style.display = 'block';
            document.getElementById('results-container').style.display = 'none';
            
            displayQuestion(0);
            updateProgress();
        }
    </script>
    <script src="dark-mode.js"></script>
</body>
</html> 