<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic de Connexion - MCQED</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="security-check.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin: 50px auto;
            max-width: 800px;
        }
        .diagnostic-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        .status-ok {
            border-color: #28a745;
            background: #f8fff9;
        }
        .status-error {
            border-color: #dc3545;
            background: #fff8f8;
        }
        .status-warning {
            border-color: #ffc107;
            background: #fffbf0;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .test-form {
            background: #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1><i class="fas fa-stethoscope"></i> Diagnostic de Connexion MCQED</h1>
            <p class="text-muted">Vérifiez et testez votre configuration de connexion</p>
        </div>

        <!-- Test de configuration -->
        <div class="diagnostic-section" id="config-test">
            <h4><i class="fas fa-cog"></i> Test de Configuration</h4>
            <div id="config-results"></div>
        </div>

        <!-- Test de connexion -->
        <div class="diagnostic-section">
            <h4><i class="fas fa-sign-in-alt"></i> Test de Connexion</h4>
            
            <div class="test-form">
                <div class="form-group">
                    <label for="test-username"><strong>Nom d'utilisateur :</strong></label>
                    <input type="text" class="form-control" id="test-username" placeholder="Entrez le nom d'utilisateur">
                </div>
                
                <div class="form-group">
                    <label for="test-password"><strong>Mot de passe :</strong></label>
                    <input type="password" class="form-control" id="test-password" placeholder="Entrez le mot de passe">
                </div>
                
                <button type="button" class="btn btn-primary" onclick="testLogin()">
                    <i class="fas fa-play"></i> Tester la Connexion
                </button>
            </div>
            
            <div id="test-results"></div>
        </div>

        <!-- Génération de hash -->
        <div class="diagnostic-section">
            <h4><i class="fas fa-hashtag"></i> Générateur de Hash</h4>
            
            <div class="form-group">
                <label for="hash-password"><strong>Mot de passe à hasher :</strong></label>
                <input type="text" class="form-control" id="hash-password" placeholder="Entrez le mot de passe">
            </div>
            
            <button type="button" class="btn btn-info" onclick="generateHash()">
                <i class="fas fa-magic"></i> Générer le Hash
            </button>
            
            <div id="hash-results"></div>
        </div>

        <!-- Informations système -->
        <div class="diagnostic-section">
            <h4><i class="fas fa-info-circle"></i> Informations Système</h4>
            <div id="system-info"></div>
        </div>

        <!-- Actions -->
        <div class="diagnostic-section">
            <h4><i class="fas fa-tools"></i> Actions</h4>
            
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success" onclick="runFullDiagnostic()">
                    <i class="fas fa-play-circle"></i> Diagnostic Complet
                </button>
                <button type="button" class="btn btn-warning" onclick="clearStorage()">
                    <i class="fas fa-trash"></i> Nettoyer le Stockage
                </button>
                <button type="button" class="btn btn-info" onclick="exportConfig()">
                    <i class="fas fa-download"></i> Exporter Config
                </button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="text-center mt-4">
            <a href="login.html" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i> Aller à la Connexion
            </a>
            <a href="password-generator.html" class="btn btn-secondary">
                <i class="fas fa-key"></i> Générateur de Mot de Passe
            </a>
        </div>

        <!-- Retour à l'accueil -->
        <div class="text-center mt-4">
            <a href="index.html" class="btn btn-secondary">
                <i class="fas fa-home"></i> Retour à l'accueil
            </a>
        </div>

    </div>

    <script src="config.js"></script>
    <script>
        // Configuration
        const SALT = "MCQED_SECURE_SALT_2024";

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            runFullDiagnostic();
        });

        // Diagnostic complet
        function runFullDiagnostic() {
            testConfiguration();
            showSystemInfo();
        }

        // Test de configuration
        function testConfiguration() {
            const results = document.getElementById('config-results');
            let html = '';

            try {
                // Test 1: Vérifier si config.js est chargé
                if (typeof MCQED_CONFIG !== 'undefined') {
                    html += '<div class="alert alert-success"><i class="fas fa-check"></i> <strong>config.js</strong> chargé avec succès</div>';
                } else {
                    html += '<div class="alert alert-danger"><i class="fas fa-times"></i> <strong>config.js</strong> non trouvé</div>';
                    results.innerHTML = html;
                    return;
                }

                // Test 2: Vérifier la structure de configuration
                const config = MCQED_CONFIG.security;
                if (config && config.credentials) {
                    html += '<div class="alert alert-success"><i class="fas fa-check"></i> Structure de configuration valide</div>';
                } else {
                    html += '<div class="alert alert-danger"><i class="fas fa-times"></i> Structure de configuration invalide</div>';
                }

                // Test 3: Afficher les identifiants actuels
                html += '<div class="alert alert-info">';
                html += '<strong>Identifiants actuels :</strong><br>';
                html += `Nom d'utilisateur : <code>${config.credentials.username}</code><br>`;
                html += `Hash du mot de passe : <code>${config.credentials.passwordHash}</code><br>`;
                html += `Salt : <code>${config.passwordSalt}</code>`;
                html += '</div>';

                // Test 4: Vérifier la longueur du hash
                if (config.credentials.passwordHash.length === 64) {
                    html += '<div class="alert alert-success"><i class="fas fa-check"></i> Hash SHA-256 valide (64 caractères)</div>';
                } else {
                    html += '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Hash de longueur inhabituelle</div>';
                }

                // Test 5: Vérifier les paramètres de sécurité
                html += '<div class="alert alert-info">';
                html += '<strong>Paramètres de sécurité :</strong><br>';
                html += `Tentatives max : ${config.maxLoginAttempts}<br>`;
                html += `Durée de verrouillage : ${Math.round(config.lockoutDuration / 60000)} minutes<br>`;
                html += `Durée de session : ${Math.round(config.sessionTimeout / 60000)} minutes`;
                html += '</div>';

            } catch (error) {
                html += `<div class="alert alert-danger"><i class="fas fa-times"></i> Erreur : ${error.message}</div>`;
            }

            results.innerHTML = html;
        }

        // Test de connexion
        function testLogin() {
            const username = document.getElementById('test-username').value.trim();
            const password = document.getElementById('test-password').value;
            const results = document.getElementById('test-results');

            if (!username || !password) {
                results.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Veuillez remplir tous les champs</div>';
                return;
            }

            try {
                // Générer le hash du mot de passe
                const hashedPassword = CryptoJS.SHA256(password + SALT).toString();
                
                // Comparer avec la configuration
                const config = MCQED_CONFIG.security.credentials;
                const isUsernameValid = username === config.username;
                const isPasswordValid = hashedPassword === config.passwordHash;

                let html = '<div class="alert alert-info">';
                html += '<strong>Résultats du test :</strong><br>';
                html += `Nom d'utilisateur : ${isUsernameValid ? '✅ Valide' : '❌ Invalide'}<br>`;
                html += `Mot de passe : ${isPasswordValid ? '✅ Valide' : '❌ Invalide'}<br>`;
                html += `Hash généré : <code>${hashedPassword}</code><br>`;
                html += `Hash attendu : <code>${config.passwordHash}</code><br>`;
                html += `Résultat final : ${isUsernameValid && isPasswordValid ? '✅ Connexion réussie' : '❌ Connexion échouée'}`;
                html += '</div>';

                results.innerHTML = html;

            } catch (error) {
                results.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times"></i> Erreur : ${error.message}</div>`;
            }
        }

        // Génération de hash
        function generateHash() {
            const password = document.getElementById('hash-password').value;
            const results = document.getElementById('hash-results');

            if (!password) {
                results.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Veuillez entrer un mot de passe</div>';
                return;
            }

            try {
                const hash = CryptoJS.SHA256(password + SALT).toString();
                
                let html = '<div class="alert alert-success">';
                html += '<strong>Hash généré :</strong><br>';
                html += `<div class="code-block">${hash}</div>`;
                html += '<strong>Configuration à mettre dans config.js :</strong><br>';
                html += '<div class="code-block">credentials: {<br>';
                html += `    username: "admin",<br>`;
                html += `    passwordHash: "${hash}"<br>`;
                html += '}</div>';
                html += '</div>';

                results.innerHTML = html;

            } catch (error) {
                results.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times"></i> Erreur : ${error.message}</div>`;
            }
        }

        // Informations système
        function showSystemInfo() {
            const info = document.getElementById('system-info');
            
            let html = '<div class="alert alert-info">';
            html += '<strong>Informations système :</strong><br>';
            html += `Navigateur : ${navigator.userAgent}<br>`;
            html += `CryptoJS disponible : ${typeof CryptoJS !== 'undefined' ? '✅ Oui' : '❌ Non'}<br>`;
            html += `localStorage disponible : ${typeof localStorage !== 'undefined' ? '✅ Oui' : '❌ Non'}<br>`;
            html += `sessionStorage disponible : ${typeof sessionStorage !== 'undefined' ? '✅ Oui' : '❌ Non'}<br>`;
            html += `Heure actuelle : ${new Date().toLocaleString('fr-FR')}`;
            html += '</div>';

            info.innerHTML = html;
        }

        // Nettoyer le stockage
        function clearStorage() {
            if (confirm('Voulez-vous vraiment nettoyer tout le stockage local ?')) {
                localStorage.clear();
                sessionStorage.clear();
                alert('Stockage nettoyé !');
                showSystemInfo();
            }
        }

        // Exporter la configuration
        function exportConfig() {
            try {
                const configData = {
                    timestamp: new Date().toISOString(),
                    config: MCQED_CONFIG
                };
                
                const blob = new Blob([JSON.stringify(configData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mcqed-config-backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('Configuration exportée avec succès !');
            } catch (error) {
                alert('Erreur lors de l\'export : ' + error.message);
            }
        }
    </script>
</body>
</html> 